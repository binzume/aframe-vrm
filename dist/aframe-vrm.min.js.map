{
  "version": 3,
  "sources": ["../src/vrm/lookat.ts", "../src/vrm/blendshape.ts", "../src/vrm/firstperson.ts", "../src/vrm/avatar.ts", "../src/utils/physics-cannon.ts", "../src/utils/simpleik.ts", "../src/utils/vmd.ts", "../src/utils/bvh.ts", "../src/aframe-vrm.js"],
  "sourcesContent": ["export class VRMLookAt implements VRMModule {\r\n    public target: THREE.Object3D | null = null;\r\n    public angleLimit: number = 60 * Math.PI / 180;\r\n    private readonly _bone: THREE.Object3D;\r\n    private readonly _identQ = new THREE.Quaternion();\r\n    private readonly _zV = new THREE.Vector3(0, 0, -1);\r\n    private readonly _tmpQ0 = new THREE.Quaternion();\r\n    private readonly _tmpV0 = new THREE.Vector3();\r\n\r\n    constructor(initCtx: InitCtx) {\r\n        this._bone = initCtx.nodes[initCtx.vrm.firstPerson.firstPersonBone];\r\n    }\r\n\r\n    public update(t: number): void {\r\n        let target = this.target;\r\n        let bone = this._bone;\r\n        if (target == null || bone == null) {\r\n            return;\r\n        }\r\n        let targetDirection = bone.worldToLocal(this._tmpV0.setFromMatrixPosition(target.matrixWorld)).normalize();\r\n        let rot = this._tmpQ0.setFromUnitVectors(this._zV, targetDirection);\r\n        let boneLimit = this.angleLimit;\r\n        let speedFactor = 0.08;\r\n        let angle = 2 * Math.acos(rot.w);\r\n        if (angle > boneLimit * 1.5) {\r\n            rot = this._identQ;\r\n            speedFactor = 0.04;\r\n        } else if (angle > boneLimit) {\r\n            rot.setFromAxisAngle(this._tmpV0.set(rot.x, rot.y, rot.z).normalize(), boneLimit);\r\n        }\r\n        bone.quaternion.slerp(rot, speedFactor);\r\n    }\r\n}\r\n", "import { VRMAvatar } from \"./avatar\" // TODO: remove circular dependency\r\n\r\nexport class VRMBlendShapeUtil {\r\n    private readonly _avatar: VRMAvatar;\r\n    private _currentShape: any = {};\r\n    private animatedMorph: any;\r\n    private morphAction: any;\r\n\r\n    constructor(avatar: VRMAvatar) {\r\n        this._avatar = avatar;\r\n    }\r\n\r\n    public setBlendShapeWeight(name: string, value: number): void {\r\n        this._currentShape[name] = value;\r\n        if (value == 0) {\r\n            delete this._currentShape[name];\r\n        }\r\n        this._updateBlendShape()\r\n    }\r\n\r\n    public getBlendShapeWeight(name: string): number {\r\n        return this._currentShape[name] || 0;\r\n    }\r\n\r\n    public resetBlendShape() {\r\n        this._currentShape = {};\r\n        this._updateBlendShape();\r\n    }\r\n\r\n    public startBlink(blinkInterval: number): void {\r\n        if (this.animatedMorph) {\r\n            return;\r\n        }\r\n        this.animatedMorph = {\r\n            name: 'BLINK',\r\n            times: [0, blinkInterval - 0.2, blinkInterval - 0.1, blinkInterval],\r\n            values: [0, 0, 1, 0]\r\n        };\r\n        this._updateBlendShape();\r\n    }\r\n\r\n    public stopBlink(): void {\r\n        this.animatedMorph = null;\r\n        this._updateBlendShape();\r\n    }\r\n\r\n    private _updateBlendShape(): void {\r\n        // TODO: refactoring. use THREE.AnimationBlendMode.\r\n        let addWeights = (data: Record<string, any>, name: string, weights: number[]) => {\r\n            let blend = this._avatar.blendShapes[name];\r\n            blend && blend.binds.forEach(bind => {\r\n                let tname = bind.target.name;\r\n                let values = data[tname] || (data[tname] = new Array(bind.target.morphTargetInfluences.length * weights.length).fill(0));\r\n                for (let t = 0; t < weights.length; t++) {\r\n                    let i = t * bind.target.morphTargetInfluences.length + bind.index;\r\n                    values[i] += Math.max(bind.weight * weights[t], values[i]); // blend func : max\r\n                }\r\n            });\r\n        };\r\n        let times = [0], trackdata: Record<string, any[]> = {};\r\n        if (this.animatedMorph) {\r\n            times = this.animatedMorph.times;\r\n            addWeights(trackdata, this.animatedMorph.name, this.animatedMorph.values);\r\n        }\r\n        for (let [name, value] of Object.entries(this._currentShape)) {\r\n            if (this._avatar.blendShapes[name]) {\r\n                addWeights(trackdata, name, new Array(times.length).fill(value));\r\n            }\r\n        }\r\n        let tracks = Object.entries(trackdata).map(([tname, values]) =>\r\n            new THREE.NumberKeyframeTrack(tname + '.morphTargetInfluences', times, values));\r\n        let nextAction = null;\r\n        if (tracks.length > 0) {\r\n            let clip = new THREE.AnimationClip('morph', undefined, tracks);\r\n            nextAction = this._avatar.mixer.clipAction(clip).setEffectiveWeight(1.0).play();\r\n        }\r\n        this.morphAction && this.morphAction.stop();\r\n        this.morphAction = nextAction;\r\n    }\r\n}\r\n", "\r\nexport class FirstPersonMeshUtil {\r\n    private readonly _firstPersonBone: THREE.Bone;\r\n    private readonly _annotatedMeshes: { flag: string, mesh: THREE.SkinnedMesh }[]\r\n    constructor(initCtx: InitCtx) {\r\n        this._firstPersonBone = initCtx.nodes[initCtx.vrm.firstPerson.firstPersonBone] as THREE.Bone;\r\n        this._annotatedMeshes =\r\n            initCtx.vrm.firstPerson.meshAnnotations.map(ma => ({ flag: ma.firstPersonFlag, mesh: initCtx.meshes[ma.mesh] }));\r\n    }\r\n    public setFirstPerson(firstPerson: boolean): void {\r\n        this._annotatedMeshes.forEach(a => {\r\n            if (a.flag == 'ThirdPersonOnly') {\r\n                a.mesh.visible = !firstPerson;\r\n            } else if (a.flag == 'FirstPersonOnly') {\r\n                a.mesh.visible = firstPerson;\r\n            } else if (a.flag == 'Auto' && this._firstPersonBone) {\r\n                if (firstPerson) {\r\n                    this._genFirstPersonMesh(a.mesh);\r\n                } else {\r\n                    this._resetFirstPersonMesh(a.mesh);\r\n                }\r\n            }\r\n        });\r\n    }\r\n    private _genFirstPersonMesh(mesh: THREE.SkinnedMesh): void {\r\n        mesh.children.forEach(c => this._genFirstPersonMesh(c as THREE.SkinnedMesh));\r\n        if (!mesh.isSkinnedMesh) {\r\n            return;\r\n        }\r\n        let firstPersonBones: Record<string, boolean> = {};\r\n        this._firstPersonBone.traverse(b => {\r\n            firstPersonBones[b.uuid] = true;\r\n        });\r\n        let skeletonBones = mesh.skeleton.bones;\r\n        let skinIndex = mesh.geometry.attributes.skinIndex;\r\n        let skinWeight = mesh.geometry.attributes.skinWeight;\r\n        let index = mesh.geometry.index!;\r\n        let vertexErase = [];\r\n        let vcount = 0, fcount = 0;\r\n        for (let i = 0; i < skinIndex.array.length; i++) {\r\n            let b = skinIndex.array[i];\r\n            if (skinWeight.array[i] > 0 && firstPersonBones[skeletonBones[b].uuid]) {\r\n                if (!vertexErase[i / skinIndex.itemSize | 0]) {\r\n                    vcount++;\r\n                    vertexErase[i / skinIndex.itemSize | 0] = true;\r\n                }\r\n            }\r\n        }\r\n        let trinagleErase = [];\r\n        for (let i = 0; i < index.count; i++) {\r\n            if (vertexErase[index.array[i]] && !trinagleErase[i / 3 | 0]) {\r\n                trinagleErase[i / 3 | 0] = true;\r\n                fcount++;\r\n            }\r\n        }\r\n        if (fcount == 0) {\r\n            return;\r\n        } else if (fcount * 3 == index.count) {\r\n            mesh.visible = false;\r\n            return;\r\n        }\r\n        // TODO: erase triangle.\r\n    }\r\n    private _resetFirstPersonMesh(mesh: THREE.SkinnedMesh): void {\r\n        mesh.children.forEach(c => this._resetFirstPersonMesh(c as THREE.SkinnedMesh));\r\n        mesh.visible = true;\r\n    }\r\n}\r\n", "import { VRMLookAt } from \"./lookat\"\r\nimport { VRMBlendShapeUtil } from \"./blendshape\"\r\nimport { FirstPersonMeshUtil } from \"./firstperson\"\r\nimport { GLTFLoader, GLTF } from \"three/examples/jsm/loaders/GLTFLoader\" // type only\r\n\r\nexport type PoseData = { bones: any[], blendShape?: any[] }\r\nexport class VRMLoader {\r\n    private readonly gltfLoader: GLTFLoader;\r\n    constructor(gltfLoader?: any) {\r\n        // @ts-ignore\r\n        this.gltfLoader = gltfLoader || new THREE.GLTFLoader(THREE.DefaultLoadingManager);\r\n    }\r\n    public async load(url: string, moduleSpecs: ModuleSpec[] = []): Promise<VRMAvatar> {\r\n        return new Promise((resolve, reject) => {\r\n            this.gltfLoader.load(url, async (gltf) => {\r\n                resolve(await new VRMAvatar(gltf).init(gltf, moduleSpecs));\r\n            }, undefined, reject);\r\n        });\r\n    }\r\n}\r\n\r\nexport class VRMAvatar {\r\n    public readonly model: THREE.Object3D & { skeleton?: THREE.Skeleton };\r\n    public readonly mixer: THREE.AnimationMixer;\r\n    public readonly bones: Record<string, THREE.Bone> = {};\r\n    public blendShapes: Record<string, { name: string, binds: Record<string, any>[] }> = {};\r\n    public readonly modules: Record<string, VRMModule> = {};\r\n    public meta: Record<string, any> = {};\r\n    public readonly isVRM: boolean;\r\n    public readonly animations: THREE.AnimationClip[];\r\n    public firstPersonBone: THREE.Bone | null = null;\r\n\r\n    private _firstPersonMeshUtil: FirstPersonMeshUtil | null = null;\r\n    private _blendShapeUtil: VRMBlendShapeUtil;\r\n\r\n    // TODO: move to another component.\r\n    public boneConstraints = {\r\n        'head': { type: 'ball', limit: 60 * Math.PI / 180, twistAxis: new THREE.Vector3(0, 1, 0), twistLimit: 60 * Math.PI / 180 },\r\n        'neck': { type: 'ball', limit: 30 * Math.PI / 180, twistAxis: new THREE.Vector3(0, 1, 0), twistLimit: 10 * Math.PI / 180 },\r\n        'leftUpperLeg': { type: 'ball', limit: 170 * Math.PI / 180, twistAxis: new THREE.Vector3(0, -1, 0), twistLimit: Math.PI / 2 },\r\n        'rightUpperLeg': { type: 'ball', limit: 170 * Math.PI / 180, twistAxis: new THREE.Vector3(0, -1, 0), twistLimit: Math.PI / 2 },\r\n        'leftLowerLeg': { type: 'hinge', axis: new THREE.Vector3(1, 0, 0), min: -170 * Math.PI / 180, max: 0 * Math.PI / 180 },\r\n        'rightLowerLeg': { type: 'hinge', axis: new THREE.Vector3(1, 0, 0), min: -170 * Math.PI / 180, max: 0 * Math.PI / 180 }\r\n    };\r\n\r\n    constructor(gltf: GLTF) {\r\n        this.model = gltf.scene;\r\n        this.mixer = new THREE.AnimationMixer(this.model);\r\n        this.isVRM = (gltf.userData.gltfExtensions || {}).VRM != null;\r\n        this.animations = gltf.animations || [];\r\n        this._blendShapeUtil = new VRMBlendShapeUtil(this);\r\n    }\r\n\r\n    public async init(gltf: GLTF, moduleSpecs: ModuleSpec[]) {\r\n        if (!this.isVRM) {\r\n            return this;\r\n        }\r\n        let vrmExt = gltf.userData.gltfExtensions.VRM as VRMExtension;\r\n        let bones = this.bones;\r\n        let nodes = await gltf.parser.getDependencies('node');\r\n        let meshes = await gltf.parser.getDependencies('mesh');\r\n        let initCtx = { nodes: nodes, meshes: meshes, vrm: vrmExt, gltf: gltf };\r\n\r\n        this.meta = vrmExt.meta;\r\n        Object.values(vrmExt.humanoid.humanBones).forEach((humanBone) => {\r\n            bones[humanBone.bone] = nodes[humanBone.node];\r\n        });\r\n        if (vrmExt.firstPerson) {\r\n            if (vrmExt.firstPerson.firstPersonBone) {\r\n                this.firstPersonBone = nodes[vrmExt.firstPerson.firstPersonBone];\r\n                this.modules.lookat = new VRMLookAt(initCtx);\r\n            }\r\n            if (vrmExt.firstPerson.meshAnnotations) {\r\n                this._firstPersonMeshUtil = new FirstPersonMeshUtil(initCtx);\r\n            }\r\n        }\r\n        this.model.skeleton = new THREE.Skeleton(Object.values(bones));\r\n        this._fixBoundingBox();\r\n        if (vrmExt.blendShapeMaster) {\r\n            this._initBlendShapes(initCtx);\r\n        }\r\n\r\n        for (let spec of moduleSpecs) {\r\n            let mod = spec.instantiate(this, initCtx);\r\n            if (mod) {\r\n                this.modules[spec.name] = mod;\r\n            }\r\n        }\r\n        return this;\r\n    }\r\n    private _initBlendShapes(ctx: InitCtx): void {\r\n        this.blendShapes = (ctx.vrm.blendShapeMaster.blendShapeGroups || []).reduce((blendShapes: Record<string, any>, bg) => {\r\n            let binds = bg.binds.flatMap(bind => {\r\n                let meshObj = ctx.meshes[bind.mesh];\r\n                return (meshObj.isSkinnedMesh ? [meshObj] : meshObj.children.filter(obj => (<THREE.SkinnedMesh>obj).isSkinnedMesh))\r\n                    .map(obj => ({ target: obj, index: bind.index, weight: bind.weight / 100 }));\r\n            });\r\n            blendShapes[(bg.presetName || bg.name).toUpperCase()] = { name: bg.name, binds: binds };\r\n            return blendShapes;\r\n        }, {});\r\n    }\r\n    private _fixBoundingBox(): void {\r\n        let bones = this.bones;\r\n        if (!bones.hips) {\r\n            return;\r\n        }\r\n        // Extends bounding box.\r\n        let tmpV = new THREE.Vector3();\r\n        let center = bones.hips.getWorldPosition(tmpV).clone();\r\n        this.model.traverse((obj) => {\r\n            let mesh = <THREE.SkinnedMesh>obj;\r\n            if (mesh.isSkinnedMesh) {\r\n                let pos = mesh.getWorldPosition(tmpV).sub(center).multiplyScalar(-1);\r\n                let r = (pos.clone().sub(mesh.geometry.boundingSphere!.center).length() + mesh.geometry.boundingSphere!.radius);\r\n                mesh.geometry.boundingSphere!.center.copy(pos);\r\n                mesh.geometry.boundingSphere!.radius = r;\r\n                mesh.geometry.boundingBox!.min.set(pos.x - r, pos.y - r, pos.z - r);\r\n                mesh.geometry.boundingBox!.max.set(pos.x + r, pos.y + r, pos.z + r);\r\n            }\r\n        });\r\n    }\r\n    public update(timeDelta: number): void {\r\n        this.mixer.update(timeDelta);\r\n        for (let m of Object.values(this.modules)) {\r\n            m.update(timeDelta);\r\n        }\r\n    }\r\n    public setModule(name: string, module: VRMModule): void {\r\n        this.removeModule(name);\r\n        this.modules[name] = module;\r\n    }\r\n    public removeModule(name: string): void {\r\n        let module = this.modules[name];\r\n        module && module.dispose && module.dispose();\r\n        delete this.modules[name];\r\n    }\r\n    public dispose(): void {\r\n        for (let m of Object.keys(this.modules)) {\r\n            this.removeModule(m);\r\n        }\r\n        this.model.traverse((obj) => {\r\n            let mesh = obj as THREE.Mesh;\r\n            if (mesh.isMesh) {\r\n                mesh.geometry.dispose();\r\n                (mesh.material as THREE.MeshBasicMaterial).map?.dispose();\r\n            }\r\n            // @ts-ignore\r\n            obj.skeleton && obj.skeleton.dispose();\r\n        });\r\n    }\r\n\r\n    // Util functions.\r\n    get lookAtTarget(): THREE.Object3D | null {\r\n        let lookat = this.modules.lookat as VRMLookAt | null;\r\n        return lookat ? lookat.target : null;\r\n    }\r\n    set lookAtTarget(v: THREE.Object3D) {\r\n        let lookat = this.modules.lookat as VRMLookAt | null;\r\n        if (lookat) {\r\n            lookat.target = v;\r\n        }\r\n    }\r\n    public setBlendShapeWeight(name: string, value: number): void {\r\n        this._blendShapeUtil.setBlendShapeWeight(name, value);\r\n    }\r\n    public getBlendShapeWeight(name: string): number {\r\n        return this._blendShapeUtil.getBlendShapeWeight(name);\r\n    }\r\n    public resetBlendShape(): void {\r\n        this._blendShapeUtil.resetBlendShape();\r\n    }\r\n    public startBlink(blinkInterval: number): void {\r\n        this._blendShapeUtil.startBlink(blinkInterval);\r\n    }\r\n    public stopBlink(): void {\r\n        this._blendShapeUtil.stopBlink();\r\n    }\r\n    public getPose(exportMorph: boolean): PoseData {\r\n        let poseData: PoseData = {\r\n            bones: Object.keys(this.bones).map((name) =>\r\n                ({ name: name, q: this.bones[name].quaternion.toArray() })\r\n            )\r\n        }\r\n        if (exportMorph) {\r\n            poseData.blendShape = Object.keys(this.blendShapes).map((name) =>\r\n                ({ name: name, value: this.getBlendShapeWeight(name) })\r\n            );\r\n        }\r\n        return poseData\r\n    }\r\n    public setPose(pose: PoseData): void {\r\n        if (pose.bones) {\r\n            for (let boneParam of pose.bones) {\r\n                if (this.bones[boneParam.name]) {\r\n                    this.bones[boneParam.name].quaternion.fromArray(boneParam.q);\r\n                }\r\n            }\r\n        }\r\n        if (pose.blendShape) {\r\n            for (let morph of pose.blendShape) {\r\n                this.setBlendShapeWeight(morph.name, morph.value)\r\n            }\r\n        }\r\n    }\r\n    public restPose(): void {\r\n        for (let b of Object.values(this.bones)) {\r\n            b.quaternion.set(0, 0, 0, 1);\r\n        }\r\n    }\r\n    public setFirstPerson(firstPerson: boolean): void {\r\n        if (this._firstPersonMeshUtil) {\r\n            this._firstPersonMeshUtil.setFirstPerson(firstPerson);\r\n        }\r\n    }\r\n}\r\n", "export class VRMPhysicsCannonJS implements VRMModule {\r\n    collisionGroup = 2;\r\n    enable = false;\r\n    binds: [THREE.Object3D, CANNON.Body][] = [];\r\n    fixedBinds: [THREE.Object3D, CANNON.Body][] = [];\r\n    bodies: CANNON.Body[] = [];\r\n    constraints: any[] = [];\r\n    private readonly _tmpQ0 = new THREE.Quaternion();\r\n    private readonly _tmpV0 = new THREE.Vector3();\r\n    private readonly _tmpV1 = new THREE.Vector3();\r\n    springBoneSystem: any;\r\n    world: CANNON.World | null = null;\r\n    internalWorld: boolean = false;\r\n    constructor(initctx: InitCtx) {\r\n        this.springBoneSystem = this._springBoneSystem();\r\n        this._init(initctx);\r\n    }\r\n    private _init(initctx: InitCtx): void {\r\n        if (!initctx.vrm.secondaryAnimation) {\r\n            return;\r\n        }\r\n        let nodes = initctx.nodes;\r\n        let secondaryAnimation = initctx.vrm.secondaryAnimation;\r\n        let allColliderGroupsMask = 0;\r\n        let colliderMarginFactor = 0.9; // TODO: Remove this.\r\n        (secondaryAnimation.colliderGroups || []).forEach((cc, i) => {\r\n            let node = nodes[cc.node];\r\n            for (let collider of cc.colliders) {\r\n                let body = new CANNON.Body({ mass: 0, collisionFilterGroup: 1 << (this.collisionGroup + i + 1), collisionFilterMask: -1 });\r\n                body.addShape(new CANNON.Sphere(collider.radius * colliderMarginFactor), collider.offset);\r\n                this.bodies.push(body);\r\n                this.fixedBinds.push([node, body]);\r\n                allColliderGroupsMask |= body.collisionFilterGroup;\r\n            }\r\n        });\r\n        for (let bg of secondaryAnimation.boneGroups || []) {\r\n            let gravity = new CANNON.Vec3().copy(bg.gravityDir || { x: 0, y: -1, z: 0 }).scale(bg.gravityPower || 0);\r\n            let radius = bg.hitRadius || 0.05;\r\n            let collisionFilterMask = ~(this.collisionGroup | allColliderGroupsMask);\r\n            for (let g of bg.colliderGroups || []) {\r\n                collisionFilterMask |= 1 << (this.collisionGroup + g + 1);\r\n            }\r\n            for (let b of bg.bones) {\r\n                let root = new CANNON.Body({ mass: 0, collisionFilterGroup: 0, collisionFilterMask: 0 });\r\n                root.position.copy(nodes[b].parent.getWorldPosition(this._tmpV0));\r\n                this.bodies.push(root);\r\n                this.fixedBinds.push([nodes[b].parent, root]);\r\n                let add = (parentBody: CANNON.Body, node: THREE.Object3D) => {\r\n                    let c = node.getWorldPosition(this._tmpV0);\r\n                    let wpos = c.clone(); // TODO\r\n                    let n = node.children.length + 1;\r\n                    if (node.children.length > 0) {\r\n                        node.children.forEach(n => {\r\n                            c.add(n.getWorldPosition(this._tmpV1));\r\n                        });\r\n                    } else {\r\n                        c.add(node.parent!.getWorldPosition(this._tmpV1).sub(c).normalize().multiplyScalar(-0.1).add(c));\r\n                        n = 2;\r\n                    }\r\n                    c.multiplyScalar(1 / n);\r\n\r\n                    let body = new CANNON.Body({\r\n                        mass: 0.5,\r\n                        linearDamping: Math.max(bg.dragForce || 0, 0.0001),\r\n                        angularDamping: Math.max(bg.dragForce || 0, 0.0001),\r\n                        collisionFilterGroup: this.collisionGroup,\r\n                        collisionFilterMask: collisionFilterMask,\r\n                        position: new CANNON.Vec3().copy(c),\r\n                    });\r\n                    body.addShape(new CANNON.Sphere(radius));\r\n                    this.bodies.push(body);\r\n\r\n                    let o = new CANNON.Vec3().copy(this._tmpV1.copy(wpos).sub(c));\r\n                    let d = new CANNON.Vec3().copy(wpos.sub(parentBody.position));\r\n                    let joint = new CANNON.PointToPointConstraint(body, o, parentBody, d);\r\n                    this.constraints.push(joint);\r\n\r\n                    this.binds.push([node, body]);\r\n                    this.springBoneSystem.objects.push({ body: body, parentBody: parentBody, force: gravity, boneGroup: bg, size: radius });\r\n                    node.children.forEach(n => (n as THREE.Bone).isBone && add(body, n));\r\n                };\r\n                add(root, nodes[b]);\r\n            }\r\n        }\r\n    }\r\n    private _springBoneSystem() {\r\n        let _q0 = new CANNON.Quaternion();\r\n        let _q1 = new CANNON.Quaternion();\r\n        let _v0 = new CANNON.Vec3();\r\n        return {\r\n            world: null as CANNON.World | null,\r\n            objects: [] as any[],\r\n            update() {\r\n                let g = this.world!.gravity, dt = this.world!.dt;\r\n                let avlimit = 0.1;\r\n                for (let b of this.objects) {\r\n                    let body = b.body, parent = b.parentBody;\r\n                    // Cancel world.gravity and apply boneGroup.gravity.\r\n                    let f = body.force, m = body.mass, g2 = b.force;\r\n                    f.x += m * (-g.x + g2.x);\r\n                    f.y += m * (-g.y + g2.y);\r\n                    f.z += m * (-g.z + g2.z);\r\n\r\n                    // angularVelocity limitation\r\n                    let av = body.angularVelocity.length();\r\n                    if (av > avlimit) {\r\n                        body.angularVelocity.scale(avlimit / av, body.angularVelocity);\r\n                    }\r\n\r\n                    // apply spring(?) force.\r\n                    let stiffness = b.boneGroup.stiffiness; // stiff'i'ness\r\n                    let approxInertia = b.size * b.size * m * 1600;\r\n                    let rot = body.quaternion.mult(parent.quaternion.inverse(_q0), _q1);\r\n                    let [axis, angle] = rot.toAxisAngle(_v0);\r\n                    angle = angle - Math.PI * 2 * Math.floor((angle + Math.PI) / (Math.PI * 2));\r\n                    let tf = angle * stiffness;\r\n                    if (Math.abs(tf) > Math.abs(angle / dt / dt * 0.00025)) {\r\n                        tf = angle / dt / dt * 0.00025; // TODO\r\n                    }\r\n                    let af = axis.scale(-tf * approxInertia, axis);\r\n                    body.torque.vadd(af, body.torque);\r\n                }\r\n            }\r\n        };\r\n    }\r\n    public attach(world: CANNON.World | null): void {\r\n        this.detach();\r\n        this.internalWorld = world == null;\r\n        this.world = world || new CANNON.World();\r\n        this.springBoneSystem.world = this.world;\r\n        this.world.subsystems.push(this.springBoneSystem);\r\n        this.bodies.forEach(b => this.world!.addBody(b));\r\n        this.constraints.forEach(c => this.world!.addConstraint(c));\r\n        this.reset();\r\n        this.enable = true;\r\n        // HACK: update collision mask.\r\n        this.world.bodies.forEach(b => {\r\n            if (b.collisionFilterGroup == 1 && b.collisionFilterMask == 1) {\r\n                b.collisionFilterMask = -1;\r\n            }\r\n        });\r\n    }\r\n    public detach(): void {\r\n        if (!this.world) {\r\n            return;\r\n        }\r\n        this.world.subsystems = this.world.subsystems.filter(s => s != this.springBoneSystem);\r\n        this.world.constraints = this.world.constraints.filter(c => !this.constraints.includes(c));\r\n        this.world.bodies = this.world.bodies.filter(b => !this.bodies.includes(b));\r\n        this.world = null;\r\n        this.enable = false;\r\n    }\r\n    public reset(): void {\r\n        this.fixedBinds.forEach(([node, body]) => {\r\n            node.updateWorldMatrix(true, false);\r\n            body.position.copy(node.getWorldPosition(this._tmpV0));\r\n            body.quaternion.copy(node.parent!.getWorldQuaternion(this._tmpQ0));\r\n        });\r\n        this.binds.forEach(([node, body]) => {\r\n            node.updateWorldMatrix(true, false);\r\n            body.position.copy(node.getWorldPosition(this._tmpV0));\r\n            body.quaternion.copy(node.getWorldQuaternion(this._tmpQ0));\r\n        });\r\n    }\r\n    public update(timeDelta: number): void {\r\n        if (!this.enable) {\r\n            return;\r\n        }\r\n        this.fixedBinds.forEach(([node, body]) => {\r\n            body.position.copy(node.getWorldPosition(this._tmpV0));\r\n            body.quaternion.copy(node.getWorldQuaternion(this._tmpQ0));\r\n        });\r\n        if (this.internalWorld) {\r\n            this.world!.step(1 / 60, timeDelta);\r\n        }\r\n        this.binds.forEach(([node, body]) => {\r\n            node.quaternion.copy(body.quaternion).premultiply(node.parent!.getWorldQuaternion(this._tmpQ0).invert());\r\n        });\r\n    }\r\n    public dispose(): void {\r\n        this.detach();\r\n    }\r\n}\r\n", "\r\nexport class IKNode {\r\n    position: THREE.Vector3;\r\n    constraint: { [key: string]: any };\r\n    userData: any;\r\n\r\n    quaternion = new THREE.Quaternion();\r\n    worldMatrix = new THREE.Matrix4();\r\n    worldPosition = new THREE.Vector3();\r\n\r\n    constructor(position: THREE.Vector3, constraint: { [key: string]: any }, userData: any) {\r\n        this.position = position;\r\n        this.constraint = constraint;\r\n        this.userData = userData;\r\n    }\r\n}\r\nexport class IKSolver {\r\n    iterationLimit = 50;\r\n    thresholdSq = 0.0001;\r\n    _iv = new THREE.Vector3(1, 1, 1);\r\n    _tmpV0 = new THREE.Vector3();\r\n    _tmpV1 = new THREE.Vector3();\r\n    _tmpV2 = new THREE.Vector3();\r\n    _tmpQ0 = new THREE.Quaternion();\r\n    _tmpQ1 = new THREE.Quaternion();\r\n\r\n    _updateChain(bones: IKNode[], parentMat: THREE.Matrix4) {\r\n        for (let bone of bones) {\r\n            bone.worldMatrix.compose(bone.position, bone.quaternion, this._iv).premultiply(parentMat);\r\n            bone.worldPosition.setFromMatrixPosition(bone.worldMatrix);\r\n            parentMat = bone.worldMatrix;\r\n        }\r\n    }\r\n    solve(bones: IKNode[], target: THREE.Vector3, boneSpaceMat: THREE.Matrix4) {\r\n        this._updateChain(bones, boneSpaceMat);\r\n        let endPosition = bones[bones.length - 1].worldPosition;\r\n        let startDistance = endPosition.distanceToSquared(target);\r\n        let targetDir = this._tmpV2;\r\n        let endDir = this._tmpV1;\r\n        let rotation = this._tmpQ1;\r\n        for (let i = 0; i < this.iterationLimit; i++) {\r\n            if (endPosition.distanceToSquared(target) < this.thresholdSq) {\r\n                break;\r\n            }\r\n            let currentTarget = this._tmpV0.copy(target);\r\n            for (let j = bones.length - 2; j >= 0; j--) {\r\n                let bone = bones[j];\r\n                let endPos = bones[j + 1].position;\r\n                bone.worldMatrix.decompose(this._tmpV1, this._tmpQ0, this._tmpV2);\r\n                targetDir.copy(currentTarget).sub(this._tmpV1).applyQuaternion(rotation.copy(this._tmpQ0).invert()).normalize();\r\n                endDir.copy(endPos).normalize();\r\n                rotation.setFromUnitVectors(endDir, targetDir);\r\n                bone.quaternion.multiply(rotation);\r\n                let v = endDir.copy(endPos).applyQuaternion(this._tmpQ0.multiply(rotation));\r\n                if (bone.constraint) {\r\n                    rotation.copy(bone.quaternion).invert();\r\n                    if (bone.constraint.apply(bone)) {\r\n                        // TODO\r\n                        rotation.premultiply(bone.quaternion);\r\n                        v.copy(endPos).applyQuaternion(this._tmpQ0.multiply(rotation));\r\n                    }\r\n                }\r\n                currentTarget.sub(v);\r\n            }\r\n            this._updateChain(bones, boneSpaceMat);\r\n        }\r\n        return endPosition.distanceToSquared(target) < startDistance;\r\n    }\r\n}\r\n\r\n\r\nexport class SimpleIK {\r\n    solver = new IKSolver();\r\n    chains: any[];\r\n    update(t : number) {\r\n\r\n    }\r\n}\r\n", "import { VRMAvatar } from \"../vrm/avatar\"\r\n\r\nexport class VMDLoaderWrapper {\r\n    boneMapping: { bone: string, nodeNames: string[] }[] = [\r\n        { \"bone\": \"hips\", \"nodeNames\": [\"\u30BB\u30F3\u30BF\u30FC\", \"center\"] },\r\n        { \"bone\": \"spine\", \"nodeNames\": [\"\u4E0A\u534A\u8EAB\", \"upper body\"] },\r\n        { \"bone\": \"chest\", \"nodeNames\": [\"\u4E0A\u534A\u8EAB2\", \"upper body2\"] },\r\n        { \"bone\": \"neck\", \"nodeNames\": [\"\u9996\", \"neck\"] },\r\n        { \"bone\": \"head\", \"nodeNames\": [\"\u982D\", \"head\"] },\r\n        { \"bone\": \"leftShoulder\", \"nodeNames\": [\"\u5DE6\u80A9\", \"shoulder_L\"] },\r\n        { \"bone\": \"leftUpperArm\", \"nodeNames\": [\"\u5DE6\u8155\", \"arm_L\"] },\r\n        { \"bone\": \"leftLowerArm\", \"nodeNames\": [\"\u5DE6\u3072\u3058\", \"elbow_L\"] },\r\n        { \"bone\": \"leftHand\", \"nodeNames\": [\"\u5DE6\u624B\u9996\", \"wrist_L\"] },\r\n        { \"bone\": \"rightShoulder\", \"nodeNames\": [\"\u53F3\u80A9\", \"shoulder_R\"] },\r\n        { \"bone\": \"rightUpperArm\", \"nodeNames\": [\"\u53F3\u8155\", \"arm_R\"] },\r\n        { \"bone\": \"rightLowerArm\", \"nodeNames\": [\"\u53F3\u3072\u3058\", \"elbow_R\"] },\r\n        { \"bone\": \"rightHand\", \"nodeNames\": [\"\u53F3\u624B\u9996\", \"wrist_R\"] },\r\n        { \"bone\": \"leftUpperLeg\", \"nodeNames\": [\"\u5DE6\u8DB3\", \"leg_L\"] },\r\n        { \"bone\": \"leftLowerLeg\", \"nodeNames\": [\"\u5DE6\u3072\u3056\", \"knee_L\"] },\r\n        { \"bone\": \"leftFoot\", \"nodeNames\": [\"\u5DE6\u8DB3\u9996\", \"ankle_L\"] },\r\n        { \"bone\": \"leftToes\", \"nodeNames\": [\"\u5DE6\u3064\u307E\u5148\", \"L toe\"] },\r\n        { \"bone\": \"rightUpperLeg\", \"nodeNames\": [\"\u53F3\u8DB3\", \"leg_R\"] },\r\n        { \"bone\": \"rightLowerLeg\", \"nodeNames\": [\"\u53F3\u3072\u3056\", \"knee_R\"] },\r\n        { \"bone\": \"rightFoot\", \"nodeNames\": [\"\u53F3\u8DB3\u9996\", \"ankle_R\"] },\r\n        { \"bone\": \"rightToes\", \"nodeNames\": [\"\u53F3\u3064\u307E\u5148\", \"R toe\"] },\r\n        { \"bone\": \"leftEye\", \"nodeNames\": [\"\u5DE6\u76EE\", \"eye_L\"] },\r\n        { \"bone\": \"rightEye\", \"nodeNames\": [\"\u53F3\u76EE\", \"eye_R\"] },\r\n        { \"bone\": \"leftThumbProximal\", \"nodeNames\": [\"\u5DE6\u89AA\u6307\uFF10\", \"thumb0_L\"] },\r\n        { \"bone\": \"leftThumbIntermediate\", \"nodeNames\": [\"\u5DE6\u89AA\u6307\uFF11\", \"thumb1_L\"] },\r\n        { \"bone\": \"leftThumbDistal\", \"nodeNames\": [\"\u5DE6\u89AA\u6307\uFF12\", \"thumb2_L\"] },\r\n        { \"bone\": \"leftIndexProximal\", \"nodeNames\": [\"\u5DE6\u4EBA\u6307\uFF11\", \"fore1_L\"] },\r\n        { \"bone\": \"leftIndexIntermediate\", \"nodeNames\": [\"\u5DE6\u4EBA\u6307\uFF12\", \"fore2_L\"] },\r\n        { \"bone\": \"leftIndexDistal\", \"nodeNames\": [\"\u5DE6\u4EBA\u6307\uFF13\", \"fore3_L\"] },\r\n        { \"bone\": \"leftMiddleProximal\", \"nodeNames\": [\"\u5DE6\u4E2D\u6307\uFF11\", \"middle1_L\"] },\r\n        { \"bone\": \"leftMiddleIntermediate\", \"nodeNames\": [\"\u5DE6\u4E2D\u6307\uFF12\", \"middle2_L\"] },\r\n        { \"bone\": \"leftMiddleDistal\", \"nodeNames\": [\"\u5DE6\u4E2D\u6307\uFF13\", \"middle3_L\"] },\r\n        { \"bone\": \"leftRingProximal\", \"nodeNames\": [\"\u5DE6\u85AC\u6307\uFF11\", \"third1_L\"] },\r\n        { \"bone\": \"leftRingIntermediate\", \"nodeNames\": [\"\u5DE6\u85AC\u6307\uFF12\", \"third2_L\"] },\r\n        { \"bone\": \"leftRingDistal\", \"nodeNames\": [\"\u5DE6\u85AC\u6307\uFF13\", \"third3_L\"] },\r\n        { \"bone\": \"leftLittleProximal\", \"nodeNames\": [\"\u5DE6\u5C0F\u6307\uFF11\", \"little1_L\"] },\r\n        { \"bone\": \"leftLittleIntermediate\", \"nodeNames\": [\"\u5DE6\u5C0F\u6307\uFF12\", \"little2_L\"] },\r\n        { \"bone\": \"leftLittleDistal\", \"nodeNames\": [\"\u5DE6\u5C0F\u6307\uFF13\", \"little3_L\"] },\r\n        { \"bone\": \"rightThumbProximal\", \"nodeNames\": [\"\u53F3\u89AA\u6307\uFF10\", \"thumb0_R\"] },\r\n        { \"bone\": \"rightThumbIntermediate\", \"nodeNames\": [\"\u53F3\u89AA\u6307\uFF11\", \"thumb1_R\"] },\r\n        { \"bone\": \"rightThumbDistal\", \"nodeNames\": [\"\u53F3\u89AA\u6307\uFF12\", \"thumb2_R\"] },\r\n        { \"bone\": \"rightIndexProximal\", \"nodeNames\": [\"\u53F3\u4EBA\u6307\uFF11\", \"fore1_R\"] },\r\n        { \"bone\": \"rightIndexIntermediate\", \"nodeNames\": [\"\u53F3\u4EBA\u6307\uFF12\", \"fore2_R\"] },\r\n        { \"bone\": \"rightIndexDistal\", \"nodeNames\": [\"\u53F3\u4EBA\u6307\uFF13\", \"fore3_R\"] },\r\n        { \"bone\": \"rightMiddleProximal\", \"nodeNames\": [\"\u53F3\u4E2D\u6307\uFF11\", \"middle1_R\"] },\r\n        { \"bone\": \"rightMiddleIntermediate\", \"nodeNames\": [\"\u53F3\u4E2D\u6307\uFF12\", \"middle2_R\"] },\r\n        { \"bone\": \"rightMiddleDistal\", \"nodeNames\": [\"\u53F3\u4E2D\u6307\uFF13\", \"middle3_R\"] },\r\n        { \"bone\": \"rightRingProximal\", \"nodeNames\": [\"\u53F3\u85AC\u6307\uFF11\", \"third1_R\"] },\r\n        { \"bone\": \"rightRingIntermediate\", \"nodeNames\": [\"\u53F3\u85AC\u6307\uFF12\", \"third2_R\"] },\r\n        { \"bone\": \"rightRingDistal\", \"nodeNames\": [\"\u53F3\u85AC\u6307\uFF13\", \"third3_R\"] },\r\n        { \"bone\": \"rightLittleProximal\", \"nodeNames\": [\"\u53F3\u5C0F\u6307\uFF11\", \"little1_R\"] },\r\n        { \"bone\": \"rightLittleIntermediate\", \"nodeNames\": [\"\u53F3\u5C0F\u6307\uFF12\", \"little2_R\"] },\r\n        { \"bone\": \"rightLittleDistal\", \"nodeNames\": [\"\u53F3\u5C0F\u6307\uFF13\", \"little3_R\"] },\r\n    ];\r\n    blendShapeMap = {\r\n        \"A\": \"\u3042\",\r\n        \"I\": \"\u3044\",\r\n        \"U\": \"\u3046\",\r\n        \"E\": \"\u3048\",\r\n        \"O\": \"\u304A\",\r\n        \"BLINK\": \"\u307E\u3070\u305F\u304D\",\r\n    };\r\n    rotationOffsets = {\r\n        \"leftUpperArm\": -38 * THREE.MathUtils.DEG2RAD,\r\n        \"rightUpperArm\": 38 * THREE.MathUtils.DEG2RAD,\r\n    };\r\n    ikConfigs = [\r\n        { target: \"\u5DE6\u8DB3\uFF29\uFF2B\", bones: [`leftFoot`, 'leftLowerLeg', 'leftUpperLeg'] },\r\n        { target: \"\u53F3\u8DB3\uFF29\uFF2B\", bones: [`rightFoot`, 'rightLowerLeg', 'rightUpperLeg'] },\r\n        { target: \"\u5DE6\u3064\u307E\u5148\uFF29\uFF2B\", parent: 0, bones: [`leftToes`, `leftFoot`] },\r\n        { target: \"\u53F3\u3064\u307E\u5148\uFF29\uFF2B\", parent: 1, bones: [`rightToes`, `rightFoot`] },\r\n    ];\r\n    boneConstraints: Record<string, any> = {\r\n        'leftLowerLeg': { min: new THREE.Vector3(-175 * Math.PI / 180, 0, 0), max: new THREE.Vector3(0, 0, 0) },\r\n        'rightLowerLeg': { min: new THREE.Vector3(-175 * Math.PI / 180, 0, 0), max: new THREE.Vector3(0, 0, 0) },\r\n        'leftUpperLeg': { min: new THREE.Vector3(-Math.PI / 2, -Math.PI / 2, -Math.PI / 2), max: new THREE.Vector3(Math.PI, Math.PI / 2, Math.PI / 2) },\r\n        'rightUpperLeg': { min: new THREE.Vector3(-Math.PI / 2, -Math.PI / 2, -Math.PI / 2), max: new THREE.Vector3(Math.PI, Math.PI / 2, Math.PI / 2) },\r\n    };\r\n\r\n    async load(url: string, vrm: VRMAvatar, options: any): Promise<THREE.AnimationClip> {\r\n        /** @ts-ignore */\r\n        let { MMDLoader } = await import('https://threejs.org/examples/jsm/loaders/MMDLoader.js');\r\n        /** @ts-ignore */\r\n        let { CCDIKSolver } = await import('https://threejs.org/examples/jsm/animation/CCDIKSolver.js');\r\n        let loader = new MMDLoader();\r\n\r\n        let nameMap: Record<string, string> = {};\r\n        for (let m of this.boneMapping) {\r\n            let boneObj = vrm.bones[m.bone];\r\n            if (boneObj) {\r\n                for (let name of m.nodeNames) {\r\n                    nameMap[name] = boneObj.name;\r\n                }\r\n            }\r\n        }\r\n        let rotationOffsets: Record<string, THREE.Quaternion> = {};\r\n        let boneTransforms: Record<string, [number, number]> = {};\r\n        for (let [name, r] of Object.entries(this.rotationOffsets)) {\r\n            let boneObj = vrm.bones[name];\r\n            if (boneObj) {\r\n                rotationOffsets[boneObj.name] = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0, 0, 1), r);\r\n                boneObj.traverse(o => {\r\n                    boneTransforms[o.name] = [Math.cos(r), Math.sin(r)]; // TODO matrix\r\n                });\r\n            }\r\n        }\r\n        let morphTargetDictionary: Record<string, string> = {};\r\n        for (let [name, morph] of Object.entries(this.blendShapeMap)) {\r\n            let b = vrm.blendShapes[name];\r\n            if (b) {\r\n                morphTargetDictionary[morph] = name;\r\n            }\r\n        }\r\n\r\n        /** @ts-ignore */\r\n        vrm.model.morphTargetDictionary = morphTargetDictionary;\r\n        let scale = 0.08; // MMD unit: 8cm\r\n        let rotY = (p: number[], t: number[]) => {\r\n            [p[0], p[2]] = [\r\n                p[0] * t[0] - p[2] * t[1],\r\n                p[0] * t[1] + p[2] * t[0]\r\n            ];\r\n        };\r\n        let rotZ = (p: number[], t: number[]) => {\r\n            [p[0], p[1]] = [\r\n                p[0] * t[0] - p[1] * t[1],\r\n                p[0] * t[1] + p[1] * t[0]\r\n            ];\r\n        };\r\n        let rot = new THREE.Quaternion();\r\n        let rot2 = new THREE.Quaternion();\r\n        return await new Promise((resolve, reject) => {\r\n            loader.loadVMD(url, async (vmd: { motions: any[] }) => {\r\n                // Cancel lower body rotation\r\n                let lowerBody = vmd.motions.filter(m => m.boneName == \"\u4E0B\u534A\u8EAB\");\r\n                if (lowerBody.length) {\r\n                    lowerBody.sort((a, b) => a.frameNum - b.frameNum);\r\n                    let update = (target: any[], inv: boolean) => {\r\n                        target.sort((a, b) => a.frameNum - b.frameNum);\r\n                        let i = 0;\r\n                        for (let m of target) {\r\n                            while (i < lowerBody.length - 1 && m.frameNum > lowerBody[i].frameNum) {\r\n                                i++;\r\n                            }\r\n                            let r = rot2.fromArray(lowerBody[i].rotation);\r\n                            if (i > 0 && m.frameNum < lowerBody[i].frameNum) {\r\n                                let t = (m.frameNum - lowerBody[i - 1].frameNum) / (lowerBody[i].frameNum - lowerBody[i - 1].frameNum);\r\n                                // TOOD: bezier interpolation.\r\n                                r.slerp(rot.fromArray(lowerBody[i - 1].rotation), 1 - t);\r\n                            }\r\n                            if (inv) r.invert();\r\n                            m.rotation = rot.fromArray(m.rotation).multiply(r).toArray();\r\n                        }\r\n                    };\r\n                    update(vmd.motions.filter(m => m.boneName == \"\u30BB\u30F3\u30BF\u30FC\"), false);\r\n                    update(vmd.motions.filter(m => m.boneName == \"\u4E0A\u534A\u8EAB\"), true);\r\n                    lowerBody.forEach(m => m.rotation = [0, 0, 0, 1]);\r\n                }\r\n                // convert bones\r\n                for (let m of vmd.motions) {\r\n                    if (nameMap[m.boneName]) {\r\n                        m.boneName = nameMap[m.boneName];\r\n                    }\r\n                    let r = rotationOffsets[m.boneName];\r\n                    if (r) {\r\n                        m.rotation = rot.fromArray(m.rotation).premultiply(r).toArray();\r\n                    }\r\n                    m.position[0] *= scale;\r\n                    m.position[1] *= scale;\r\n                    m.position[2] *= scale;\r\n                    rotY(m.position, [-1, 0]);\r\n                    rotY(m.rotation, [-1, 0]);\r\n                    let t = boneTransforms[m.boneName];\r\n                    if (t) {\r\n                        rotZ(m.position, t);\r\n                        rotZ(m.rotation, t);\r\n                    }\r\n                }\r\n\r\n                if (options.enableIK) {\r\n                    /** @type {THREE.Bone[]} */\r\n                    // @ts-ignore\r\n                    let skeletonBones = vrm.model.skeleton.bones as any[];\r\n                    let getTargetBone = (config: { target: string, parent?: any, bones: any[] }) => {\r\n                        let targetIndex = skeletonBones.findIndex(b => b.name == config.target);\r\n                        if (targetIndex >= 0) {\r\n                            return targetIndex;\r\n                        }\r\n                        let parentObj = config.parent != null ? skeletonBones[getTargetBone(this.ikConfigs[config.parent])] : vrm.model;\r\n                        let dummyBone = new THREE.Bone();\r\n                        dummyBone.name = config.target;\r\n                        skeletonBones.push(dummyBone);\r\n                        parentObj.add(dummyBone);\r\n                        parentObj.updateMatrixWorld();\r\n                        let initPos = vrm.bones[config.bones[0]].getWorldPosition(new THREE.Vector3());\r\n                        dummyBone.position.copy(initPos.applyMatrix4(parentObj.matrixWorld.clone().invert()));\r\n\r\n                        // DEBUG\r\n                        //let geometry = new THREE.BoxGeometry(0.01, 0.01, 0.01);\r\n                        //let material = new THREE.MeshBasicMaterial({\r\n                        //\tcolor: new THREE.Color(\"red\"),\r\n                        //\ttransparent: true, opacity: 0.4, depthTest: false,\r\n                        //});\r\n                        //dummyBone.add(new THREE.Mesh(geometry, material));\r\n                        return skeletonBones.length - 1;\r\n                    }\r\n                    let iks = [];\r\n                    for (let config of this.ikConfigs) {\r\n                        // TODO: IK on/off setting from vmd.\r\n                        if (vmd.motions.find(m => m.boneName == config.target) == undefined) {\r\n                            continue;\r\n                        }\r\n                        let boneIndex = (name: string) => skeletonBones.findIndex(b => b == vrm.bones[name]);\r\n                        let effectorIndex = boneIndex(config.bones[0]);\r\n                        if (effectorIndex < 0) {\r\n                            continue;\r\n                        }\r\n                        let links: any[] = [];\r\n                        config.bones.slice(1).forEach(name => {\r\n                            let index = boneIndex(name);\r\n                            if (index >= 0) {\r\n                                let link: { index: number, rotationMax?: any, rotationMin?: any } = { index: index };\r\n                                let constraint = this.boneConstraints[name];\r\n                                if (constraint) {\r\n                                    link.rotationMax = constraint.max;\r\n                                    link.rotationMin = constraint.min;\r\n                                }\r\n                                links.push(link);\r\n                            }\r\n                        });\r\n                        let ik = {\r\n                            target: getTargetBone(config),\r\n                            effector: effectorIndex,\r\n                            links: links,\r\n                            maxAngle: 1,\r\n                            iteration: 4,\r\n                        };\r\n                        iks.push(ik);\r\n                    }\r\n                    if (iks.length > 0) {\r\n                        console.log(iks);\r\n                        let ikSolver = new CCDIKSolver(vrm.model, iks);\r\n                        vrm.setModule('MMDIK', { update: (t) => ikSolver.update() });\r\n                    }\r\n                }\r\n\r\n                let clip = loader.animationBuilder.build(vmd, vrm.model) as THREE.AnimationClip;\r\n                clip.tracks.forEach(tr => {\r\n                    let m = tr.name.match(/.morphTargetInfluences\\[(\\w+)\\]/);\r\n                    if (m) {\r\n                        let b = vrm.blendShapes[m[1]];\r\n                        if (b && b.binds.length > 0) {\r\n                            // todo clone track.\r\n                            tr.name = b.binds[0].target.uuid + \".morphTargetInfluences[\" + b.binds[0].index + \"]\";\r\n                        }\r\n                    }\r\n                });\r\n                resolve(clip);\r\n            }, () => { }, reject);\r\n        });\r\n    }\r\n}\r\n", "import { VRMAvatar } from '../vrm/avatar';\r\n\r\nexport class BVHLoaderWrapper {\r\n    public async load(url: string, avatar: VRMAvatar, options: any): Promise<THREE.AnimationClip> {\r\n        /** @ts-ignore */\r\n        let { BVHLoader } = await import('https://threejs.org/examples/jsm/loaders/BVHLoader.js');\r\n        return await new Promise((resolve, reject) => {\r\n            new BVHLoader().load(url, (result: any) => {\r\n                if (options.convertBone) {\r\n                    this.fixTrackName(result.clip, avatar);\r\n                }\r\n                result.clip.tracks = result.clip.tracks.filter((t: any) => !t.name.match(/position/) || t.name.match(avatar.bones.hips.name));\r\n                resolve(result.clip);\r\n            });\r\n        });\r\n    }\r\n\r\n    protected convertBoneName(name: string): string {\r\n        name = name.replace('Spin1', 'Spin');\r\n        name = name.replace('Chest1', 'Chest');\r\n        name = name.replace('Chest2', 'UpperChest');\r\n        name = name.replace('UpLeg', 'UpperLeg');\r\n        name = name.replace('LeftLeg', 'LeftLowerLeg');\r\n        name = name.replace('RightLeg', 'RightLowerLeg');\r\n        name = name.replace('ForeArm', 'UpperArm');\r\n        name = name.replace('LeftArm', 'LeftLowerArm');\r\n        name = name.replace('RightArm', 'RightLowerArm');\r\n        name = name.replace('Collar', 'Shoulder');\r\n        name = name.replace('Elbow', 'LowerArm');\r\n        name = name.replace('Wrist', 'Hand');\r\n        name = name.replace('LeftHip', 'LeftUpperLeg');\r\n        name = name.replace('RightHip', 'RightUpperLeg');\r\n        name = name.replace('Knee', 'LowerLeg');\r\n        name = name.replace('Ankle', 'Foot');\r\n        return name.charAt(0).toLowerCase() + name.slice(1);\r\n    }\r\n\r\n    protected fixTrackName(clip: THREE.AnimationClip, avatar: VRMAvatar): void {\r\n        clip.tracks.forEach(t => {\r\n            // '.bones[Chest].quaternion'\r\n            t.name = t.name.replace(/bones\\[(\\w+)\\]/, (m, name) => {\r\n                let bone = avatar.bones[this.convertBoneName(name)];\r\n                return 'bones[' + (bone != null ? bone.name : 'NODE_NOT_FOUND') + ']';\r\n            });\r\n            t.name = t.name.replace('ToeBase', 'Foot');\r\n            if (t.name.match(/quaternion/)) {\r\n                t.values = t.values.map((v, i) => i % 2 === 0 ? -v : v);\r\n            }\r\n            if (t.name.match(/position/)) {\r\n                t.values = t.values.map((v, i) => (i % 3 === 1 ? v : -v) * 0.09); // TODO\r\n            }\r\n        });\r\n        clip.tracks = clip.tracks.filter(t => !t.name.match(/NODE_NOT_FOUND/));\r\n    }\r\n}\r\n", "// @ts-nocheck\r\nimport { VRMAvatar, VRMLoader } from \"./vrm/avatar\";\r\nimport { VRMPhysicsCannonJS } from \"./utils/physics-cannon\";\r\nimport { IKNode, IKSolver } from \"./utils/simpleik\";\r\nimport { VMDLoaderWrapper } from \"./utils/vmd\";\r\nimport { BVHLoaderWrapper } from \"./utils/bvh\";\r\n\r\nAFRAME.registerComponent('vrm', {\r\n    schema: {\r\n        src: { default: '' },\r\n        firstPerson: { default: false },\r\n        blink: { default: true },\r\n        blinkInterval: { default: 5 },\r\n        lookAt: { type: 'selector' },\r\n        enablePhysics: { default: false },\r\n    },\r\n    init() {\r\n        this.avatar = null;\r\n    },\r\n    update(oldData) {\r\n        if (this.data.src !== oldData.src) {\r\n            this.remove();\r\n            this._loadAvatar();\r\n        }\r\n        this._updateAvatar();\r\n    },\r\n    tick(time, timeDelta) {\r\n        if (!this.avatar) {\r\n            this.pause();\r\n            return;\r\n        }\r\n        this.avatar.update(timeDelta / 1000);\r\n    },\r\n    remove() {\r\n        if (this.avatar) {\r\n            this.el.removeObject3D('avatar');\r\n            this.avatar.dispose();\r\n        }\r\n    },\r\n    async _loadAvatar() {\r\n        let el = this.el;\r\n        let url = this.data.src;\r\n        if (!url) {\r\n            return;\r\n        }\r\n        try {\r\n            let moduleSpecs = [];\r\n            if (globalThis.CANNON) {\r\n                moduleSpecs.push({ name: 'physics', instantiate: (a, ctx) => new VRMPhysicsCannonJS(ctx) });\r\n            }\r\n            let avatar = await new VRMLoader().load(url, moduleSpecs);\r\n            if (url != this.data.src) {\r\n                avatar.dispose();\r\n                return;\r\n            }\r\n            this.avatar = avatar;\r\n            el.setObject3D('avatar', avatar.model);\r\n            this._updateAvatar();\r\n            this.play();\r\n            el.emit('model-loaded', { format: 'vrm', model: avatar.model, avatar: avatar }, false);\r\n        } catch (e) {\r\n            el.emit('model-error', { format: 'vrm', src: url, cause: e }, false);\r\n        }\r\n    },\r\n    _updateAvatar() {\r\n        if (!this.avatar) {\r\n            return;\r\n        }\r\n        let data = this.data;\r\n        this.avatar.setFirstPerson(data.firstPerson);\r\n        if (data.lookAt) {\r\n            if (data.lookAt.tagName == 'A-CAMERA') {\r\n                this.avatar.lookAtTarget = this.el.sceneEl.camera;\r\n            } else {\r\n                this.avatar.lookAtTarget = data.lookAt.object3D;\r\n            }\r\n        } else {\r\n            this.avatar.lookAtTarget = null;\r\n        }\r\n        if (data.blink) {\r\n            this.avatar.startBlink(data.blinkInterval);\r\n        } else {\r\n            this.avatar.stopBlink();\r\n        }\r\n        /** @type {VRMPhysicsCannonJS} */\r\n        let physics = this.avatar.modules.physics;\r\n        if (physics) {\r\n            if (data.enablePhysics && physics.world == null) {\r\n                let engine = this.el.sceneEl.systems.physics;\r\n                // @ts-ignore\r\n                physics.attach(engine && engine.driver && engine.driver.world);\r\n            }\r\n            physics.enable = data.enablePhysics;\r\n        }\r\n    }\r\n});\r\n\r\nAFRAME.registerComponent('vrm-anim', {\r\n    schema: {\r\n        src: { default: '' },\r\n        format: { default: '' },\r\n        loop: { default: true },\r\n        enableIK: { default: true },\r\n        convertBone: { default: true },\r\n    },\r\n    init() {\r\n        /** @type {VRMAvatar} */\r\n        this.avatar = null;\r\n        if (this.el.components.vrm && this.el.components.vrm.avatar) {\r\n            this.avatar = this.el.components.vrm.avatar;\r\n        }\r\n        this.onVrmLoaded = (ev) => {\r\n            this.avatar = ev.detail.avatar;\r\n            if (this.data.src != '') {\r\n                this._loadClip(this.data.src);\r\n            } else if (this.avatar.animations.length > 0) {\r\n                this.playClip(this.avatar.animations[0]);\r\n            } else {\r\n                this.playTestMotion();\r\n            }\r\n        };\r\n        this.el.addEventListener('model-loaded', this.onVrmLoaded);\r\n    },\r\n    update(oldData) {\r\n        if (oldData.src != this.data.src && this.avatar) {\r\n            this._loadClip(this.data.src);\r\n        }\r\n    },\r\n    /**\r\n     * \r\n     * @param {string} url \r\n     * @returns \r\n     */\r\n    async _loadClip(url) {\r\n        this.stopAnimation();\r\n        this.avatar.restPose();\r\n        if (url === '') {\r\n            return;\r\n        }\r\n        let loop = this.data.loop ? THREE.LoopRepeat : THREE.LoopOnce;\r\n        let format = this.data.format || (url.toLowerCase().endsWith('.bvh') ? 'bvh' : '');\r\n        let loader = format == 'bvh' ? new BVHLoaderWrapper() : new VMDLoaderWrapper()\r\n        let clip = await loader.load(url, this.avatar, this.data);\r\n        if (!this.avatar) {\r\n            return;\r\n        }\r\n        this.playClip(clip);\r\n    },\r\n    stopAnimation() {\r\n        if (this.animation) {\r\n            this.animation.stop();\r\n            this.avatar.mixer.uncacheClip(this.clip);\r\n            this.avatar.removeModule('MMDIK');\r\n            this.animation = null;\r\n        }\r\n    },\r\n    playTestMotion() {\r\n        let q = (x, y, z) => new THREE.Quaternion().setFromEuler(new THREE.Euler(x * Math.PI / 180, y * Math.PI / 180, z * Math.PI / 180));\r\n        let tracks = {\r\n            leftUpperArm: {\r\n                keys: [\r\n                    { rot: q(0, 0, 65), time: 0 },\r\n                    { rot: q(0, 0, 63), time: 1 },\r\n                    { rot: q(0, 0, 65), time: 2 },\r\n                ]\r\n            },\r\n            rightUpperArm: {\r\n                keys: [\r\n                    { rot: q(0, 0, -65), time: 0 },\r\n                    { rot: q(0, 0, -60), time: 1 },\r\n                    { rot: q(0, 0, -65), time: 2 },\r\n                ]\r\n            },\r\n            spine: {\r\n                keys: [\r\n                    { rot: q(0, 2, 0), time: 0 },\r\n                    { rot: q(2, 0, -2), time: 1 },\r\n                    { rot: q(2, -2, 0), time: 2 },\r\n                    { rot: q(0, 0, 2), time: 3 },\r\n                    { rot: q(0, 2, 0), time: 4 },\r\n                ]\r\n            }\r\n        };\r\n        let clip = THREE.AnimationClip.parseAnimation(\r\n            {\r\n                name: 'testAnimation',\r\n                hierarchy: Object.values(tracks),\r\n            },\r\n            Object.keys(tracks).map(k => this.avatar.bones[k] || { name: k })\r\n        );\r\n        this.playClip(clip);\r\n    },\r\n    playClip(clip) {\r\n        let loop = this.data.loop ? THREE.LoopRepeat : THREE.LoopOnce;\r\n        this.stopAnimation();\r\n        this.clip = clip;\r\n        this.avatar.mixer.setTime(0);\r\n        this.animation = this.avatar.mixer.clipAction(clip).setLoop(loop).setEffectiveWeight(1.0).play();\r\n        this.animation.clampWhenFinished = true;\r\n    },\r\n    remove() {\r\n        this.el.removeEventListener('model-loaded', this.onVrmLoaded);\r\n        this.stopAnimation();\r\n        this.avatar = null;\r\n    }\r\n});\r\n\r\nAFRAME.registerComponent('vrm-skeleton', {\r\n    schema: {\r\n        physicsOffset: { type: 'vec3', default: { x: 0, y: 0, z: 0 } },\r\n    },\r\n    init() {\r\n        this.physicsBodies = [];\r\n        this.sceneObj = this.el.sceneEl.object3D;\r\n        if (this.el.components.vrm && this.el.components.vrm.avatar) {\r\n            this._onAvatarUpdated(this.el.components.vrm.avatar);\r\n        }\r\n        this.onVrmLoaded = (ev) => this._onAvatarUpdated(ev.detail.avatar);\r\n        this.el.addEventListener('model-loaded', this.onVrmLoaded);\r\n    },\r\n    _onAvatarUpdated(avatar) {\r\n        if (this.helper) {\r\n            this.sceneObj.remove(this.helper);\r\n        }\r\n        this.helper = new THREE.SkeletonHelper(avatar.model);\r\n        this.sceneObj.add(this.helper);\r\n        this._updatePhysicsBody(avatar);\r\n    },\r\n    _updatePhysicsBody(avatar) {\r\n        this._clearPhysicsBody();\r\n        /** @type {VRMPhysicsCannonJS} */\r\n        let physics = avatar.modules.physics;\r\n        if (!physics || !physics.world) {\r\n            return;\r\n        }\r\n        let geometry = new THREE.SphereGeometry(1, 6, 3);\r\n        let material = new THREE.MeshBasicMaterial({ color: new THREE.Color(\"red\"), wireframe: true, depthTest: false });\r\n        physics.bodies.forEach(body => {\r\n            let obj = new THREE.Group();\r\n            body.shapes.forEach((shape, i) => {\r\n                let sphere = new THREE.Mesh(geometry, material);\r\n                sphere.position.copy(body.shapeOffsets[i]);\r\n                sphere.scale.multiplyScalar(shape.boundingSphereRadius || 0.01);\r\n                obj.add(sphere);\r\n\r\n            });\r\n            this.sceneObj.add(obj);\r\n            this.physicsBodies.push([body, obj]);\r\n        });\r\n    },\r\n    _clearPhysicsBody() {\r\n        this.physicsBodies.forEach(([body, obj]) => obj.parent.remove(obj));\r\n        this.physicsBodies = [];\r\n    },\r\n    tick() {\r\n        this.physicsBodies.forEach(([body, obj]) => {\r\n            obj.position.copy(body.position).add(this.data.physicsOffset);\r\n            obj.quaternion.copy(body.quaternion);\r\n        });\r\n    },\r\n    remove() {\r\n        this.el.removeEventListener('model-loaded', this.onVrmLoaded);\r\n        this._clearPhysicsBody();\r\n        if (this.helper) {\r\n            this.sceneObj.remove(this.helper);\r\n        }\r\n    }\r\n});\r\n\r\nAFRAME.registerComponent('vrm-poser', {\r\n    schema: {\r\n        color: { default: '#00ff00' },\r\n        enableConstraints: { default: true },\r\n    },\r\n    init() {\r\n        this.binds = [];\r\n        this._tmpV0 = new THREE.Vector3();\r\n        this._tmpV1 = new THREE.Vector3();\r\n        this._tmpQ0 = new THREE.Quaternion();\r\n        this._tmpQ1 = new THREE.Quaternion();\r\n        this._tmpM0 = new THREE.Matrix4();\r\n        if (this.el.components.vrm && this.el.components.vrm.avatar) {\r\n            this._onAvatarUpdated(this.el.components.vrm.avatar);\r\n        }\r\n        this.onVrmLoaded = (ev) => this._onAvatarUpdated(ev.detail.avatar);\r\n        this.el.addEventListener('model-loaded', this.onVrmLoaded);\r\n    },\r\n    remove() {\r\n        this.el.removeEventListener('model-loaded', this.onVrmLoaded);\r\n        this._removeHandles();\r\n    },\r\n    getPoseData(exportMorph) {\r\n        if (!this.avatar) {\r\n            return;\r\n        }\r\n        return this.avatar.getPose(exportMorph);\r\n    },\r\n    setPoseData(pose) {\r\n        if (!this.avatar) {\r\n            return;\r\n        }\r\n        this.avatar.setPose(pose);\r\n        this._updateHandlePosition();\r\n    },\r\n    _onAvatarUpdated(avatar) {\r\n        this._removeHandles();\r\n        this.avatar = avatar;\r\n        let geometry = new THREE.BoxGeometry(1, 1, 1);\r\n        let material = new THREE.MeshBasicMaterial({\r\n            color: new THREE.Color(this.data.color),\r\n            transparent: true, opacity: 0.4, depthTest: false,\r\n        });\r\n        let _v0 = this._tmpV0, _v1 = this._tmpV1, _m = this._tmpM0, _q = this._tmpQ0;\r\n        let rootNode = avatar.bones['hips'];\r\n        let boneNameByUUID = {};\r\n        for (let name of Object.keys(avatar.bones)) {\r\n            let bone = avatar.bones[name];\r\n            let isRoot = bone == rootNode;\r\n            let cube = new THREE.Mesh(geometry, material);\r\n            let targetEl = document.createElement('a-entity');\r\n            targetEl.classList.add('collidable');\r\n            targetEl.setAttribute('xy-drag-control', {});\r\n            targetEl.setObject3D('handle', cube);\r\n            let targetObject = targetEl.object3D;\r\n            let minDist = bone.children.reduce((d, b) => Math.min(d, b.position.length()), bone.position.length());\r\n            targetObject.scale.multiplyScalar(Math.max(Math.min(minDist / 2, 0.05), 0.01));\r\n            boneNameByUUID[bone.uuid] = name;\r\n            targetEl.addEventListener('mousedown', ev => {\r\n                this.el.emit('vrm-poser-select', { name: name, node: bone });\r\n            });\r\n            let parentBone = bone.parent;\r\n            while (!boneNameByUUID[parentBone.uuid] && parentBone.parent && parentBone.parent.isBone) {\r\n                parentBone = parentBone.parent;\r\n            }\r\n            targetEl.addEventListener('xy-drag', ev => {\r\n                if (isRoot) {\r\n                    // TODO\r\n                    let d = targetObject.parent.worldToLocal(bone.getWorldPosition(_v0)).sub(targetObject.position)\r\n                    avatar.model.position.sub(d);\r\n                }\r\n                parentBone.updateMatrixWorld(false);\r\n                targetObject.updateMatrixWorld(false);\r\n                _m.getInverse(parentBone.matrixWorld).multiply(targetObject.matrixWorld).decompose(_v1, _q, _v0);\r\n                bone.quaternion.copy(this._applyConstraintQ(name, _q));\r\n                _q.setFromUnitVectors(_v0.copy(bone.position).normalize(), _v1.normalize());\r\n                if (parentBone.children.length == 1) {\r\n                    parentBone.quaternion.multiply(_q);\r\n                    this._applyConstraintQ(boneNameByUUID[parentBone.uuid], parentBone.quaternion)\r\n                }\r\n                this._updateHandlePosition(isRoot ? null : bone);\r\n            });\r\n            targetEl.addEventListener('xy-dragend', ev => {\r\n                this._updateHandlePosition();\r\n                console.log(parentBone.name, name);\r\n            });\r\n            this.el.appendChild(targetEl);\r\n            this.binds.push([bone, targetObject]);\r\n        }\r\n        this._updateHandlePosition();\r\n    },\r\n    _applyConstraintQ(name, q) {\r\n        if (!this.data.enableConstraints) {\r\n            return q;\r\n        }\r\n        let _q = this._tmpQ1, _v = this._tmpV0;\r\n        let constraint = this.avatar.boneConstraints[name];\r\n        if (constraint && constraint.type == 'ball') {\r\n            let angle = 2 * Math.acos(q.w);\r\n            if (constraint.twistAxis) {\r\n                let tangle = angle * Math.acos(q.w) * _v.copy(q).normalize().dot(constraint.twistAxis); // TODO\r\n                tangle = this._normalizeAngle(tangle);\r\n                if (Math.abs(tangle) > constraint.twistLimit) {\r\n                    let e = tangle < 0 ? (tangle + constraint.twistLimit) : (tangle - constraint.twistLimit);\r\n                    q.multiply(_q.setFromAxisAngle(constraint.twistAxis, -e));\r\n                    angle = 2 * Math.acos(q.w);\r\n                }\r\n            }\r\n            if (Math.abs(this._normalizeAngle(angle)) > constraint.limit) {\r\n                q.setFromAxisAngle(_v.copy(q).normalize(), constraint.limit);\r\n            }\r\n        } else if (constraint && constraint.type == 'hinge') {\r\n            let m = (constraint.min + constraint.max) / 2;\r\n            let angle = 2 * Math.acos(q.w) * _v.copy(q).normalize().dot(constraint.axis); // TODO\r\n            angle = THREE.MathUtils.clamp(this._normalizeAngle(angle - m), constraint.min - m, constraint.max - m);\r\n            q.setFromAxisAngle(constraint.axis, angle + m);\r\n        }\r\n        return q;\r\n    },\r\n    _normalizeAngle(angle) {\r\n        return angle - Math.PI * 2 * Math.floor((angle + Math.PI) / (Math.PI * 2));\r\n    },\r\n    _removeHandles() {\r\n        this.binds.forEach(([b, t]) => {\r\n            this.el.removeChild(t.el);\r\n            let obj = t.el.getObject3D('handle');\r\n            if (obj) {\r\n                obj.material.dispose();\r\n                obj.geometry.dispose();\r\n            }\r\n            t.el.destroy();\r\n        });\r\n        this.binds = [];\r\n    },\r\n    _updateHandlePosition(skipNode) {\r\n        let _v = this._tmpV0;\r\n        let container = this.el.object3D;\r\n        container.updateMatrixWorld(false);\r\n        let base = container.matrixWorld.clone().invert();\r\n        this.binds.forEach(([node, target]) => {\r\n            let pos = node == skipNode ? _v : target.position;\r\n            node.updateMatrixWorld(false);\r\n            target.matrix.copy(node.matrixWorld).premultiply(base).decompose(pos, target.quaternion, _v);\r\n        });\r\n    }\r\n});\r\n\r\nAFRAME.registerComponent('vrm-mimic', {\r\n    schema: {\r\n        leftHandTarget: { type: 'selector', default: '' },\r\n        leftHandOffsetPosition: { type: 'vec3' },\r\n        leftHandOffsetRotation: { type: 'vec3', default: { x: 0, y: -Math.PI / 2, z: 0 } },\r\n        rightHandTarget: { type: 'selector', default: '' },\r\n        rightHandOffsetPosition: { type: 'vec3' },\r\n        rightHandOffsetRotation: { type: 'vec3', default: { x: 0, y: Math.PI / 2, z: 0 } },\r\n        leftLegTarget: { type: 'selector', default: '' },\r\n        rightLegTarget: { type: 'selector', default: '' },\r\n        headTarget: { type: 'selector', default: '' },\r\n        avatarOffset: { type: 'vec3', default: { x: 0, y: 0, z: 0 } },\r\n    },\r\n    init() {\r\n        this._tmpV0 = new THREE.Vector3();\r\n        this._tmpV1 = new THREE.Vector3();\r\n        this._tmpQ0 = new THREE.Quaternion();\r\n        this._tmpQ1 = new THREE.Quaternion();\r\n        this._tmpM0 = new THREE.Matrix4();\r\n        this.targetEls = [];\r\n        if (this.el.components.vrm && this.el.components.vrm.avatar) {\r\n            this._onAvatarUpdated(this.el.components.vrm.avatar);\r\n        }\r\n        this.onVrmLoaded = (ev) => this._onAvatarUpdated(ev.detail.avatar);\r\n        this.el.addEventListener('model-loaded', this.onVrmLoaded);\r\n    },\r\n    update() {\r\n        if (this.data.headTarget) {\r\n            if (this.data.headTarget.tagName == 'A-CAMERA') {\r\n                this.headTarget = this.el.sceneEl.camera;\r\n            } else {\r\n                this.headTarget = this.data.headTarget.object3D;\r\n            }\r\n        } else {\r\n            this.headTarget = null;\r\n        }\r\n\r\n        this.rightHandOffset = new THREE.Matrix4().compose(\r\n            this.data.rightHandOffsetPosition,\r\n            new THREE.Quaternion().setFromEuler(new THREE.Euler().setFromVector3(this.data.rightHandOffsetRotation)),\r\n            new THREE.Vector3(1, 1, 1));\r\n        this.leftHandOffset = new THREE.Matrix4().compose(\r\n            this.data.leftHandOffsetPosition,\r\n            new THREE.Quaternion().setFromEuler(new THREE.Euler().setFromVector3(this.data.leftHandOffsetRotation)),\r\n            new THREE.Vector3(1, 1, 1));\r\n    },\r\n    _onAvatarUpdated(avatar) {\r\n        this.avatar = avatar;\r\n        for (let el of this.targetEls) {\r\n            this.el.removeChild(el);\r\n        }\r\n        this.targetEls = [];\r\n        this.update();\r\n        this.startAvatarIK_simpleIK(avatar);\r\n    },\r\n    startAvatarIK_simpleIK(avatar) {\r\n        let solver = new IKSolver();\r\n        this.qbinds = [];\r\n        let setupIkChain = (boneNames, targetEl, offset) => {\r\n            if (targetEl == null) {\r\n                targetEl = document.createElement('a-box');\r\n                targetEl.classList.add('collidable');\r\n                targetEl.setAttribute('xy-drag-control', {});\r\n                targetEl.setAttribute('geometry', { width: 0.05, depth: 0.05, height: 0.05 });\r\n                targetEl.setAttribute('material', { color: 'blue', depthTest: false, transparent: true, opacity: 0.4 });\r\n                this.el.appendChild(targetEl);\r\n                this.targetEls.push(targetEl);\r\n            }\r\n            let pos = (b, p) => p.worldToLocal(b.getWorldPosition(new THREE.Vector3()));\r\n            boneNames = boneNames.filter(name => avatar.bones[name]);\r\n            let boneList = boneNames.map(name => avatar.bones[name]);\r\n            let bones = boneList.map((b, i) => {\r\n                let position = i == 0 ? b.position : pos(b, boneList[i - 1]);\r\n                let constraintConf = avatar.boneConstraints[boneNames[i]];\r\n                let constraint = constraintConf ? {\r\n                    apply: ikbone => {\r\n                        return this._applyConstraintQ(constraintConf, ikbone.quaternion);\r\n                    }\r\n                } : null;\r\n                return new IKNode(position, constraint, b);\r\n            });\r\n            this.qbinds.push([boneList[boneList.length - 1], targetEl.object3D, offset]);\r\n            return { root: boneList[0], ikbones: bones, bones: boneList, target: targetEl.object3D };\r\n        };\r\n\r\n        this.chains = [\r\n            setupIkChain(['leftUpperArm', 'leftLowerArm', 'leftHand'], this.data.leftHandTarget, this.leftHandOffset),\r\n            setupIkChain(['rightUpperArm', 'rightLowerArm', 'rightHand'], this.data.rightHandTarget, this.rightHandOffset),\r\n            setupIkChain(['leftUpperLeg', 'leftLowerLeg', 'leftFoot'], this.data.leftLegTarget),\r\n            setupIkChain(['rightUpperLeg', 'rightLowerLeg', 'rightFoot'], this.data.rightLegTarget),\r\n        ];\r\n\r\n        this.simpleIK = solver;\r\n    },\r\n    _applyConstraintQ(constraint, q) {\r\n        let _q = this._tmpQ1, _v = this._tmpV0, fixed = false;;\r\n        if (constraint && constraint.type == 'ball') {\r\n            let angle = 2 * Math.acos(q.w);\r\n            if (constraint.twistAxis) {\r\n                let tangle = angle * Math.acos(q.w) * _v.copy(q).normalize().dot(constraint.twistAxis); // TODO\r\n                tangle = this._normalizeAngle(tangle);\r\n                if (Math.abs(tangle) > constraint.twistLimit) {\r\n                    let e = tangle < 0 ? (tangle + constraint.twistLimit) : (tangle - constraint.twistLimit);\r\n                    q.multiply(_q.setFromAxisAngle(constraint.twistAxis, -e));\r\n                    angle = 2 * Math.acos(q.w);\r\n                    fixed = true;\r\n                }\r\n            }\r\n            if (Math.abs(this._normalizeAngle(angle)) > constraint.limit) {\r\n                q.setFromAxisAngle(_v.copy(q).normalize(), constraint.limit);\r\n                fixed = true;\r\n            }\r\n        } else if (constraint && constraint.type == 'hinge') {\r\n            let m = (constraint.min + constraint.max) / 2;\r\n            let dot = _v.copy(q).normalize().dot(constraint.axis);\r\n            let angle = 2 * Math.acos(q.w) * dot; // TODO\r\n            angle = THREE.MathUtils.clamp(this._normalizeAngle(angle - m), constraint.min - m, constraint.max - m);\r\n            q.setFromAxisAngle(constraint.axis, angle + m);\r\n            fixed = true;\r\n        }\r\n        return fixed;\r\n    },\r\n    _normalizeAngle(angle) {\r\n        return angle - Math.PI * 2 * Math.floor((angle + Math.PI) / (Math.PI * 2));\r\n    },\r\n    tick(time, timeDelta) {\r\n        if (!this.avatar) {\r\n            return;\r\n        }\r\n        if (this.headTarget) {\r\n            let position = this._tmpV0;\r\n            let headRot = this._tmpQ0;\r\n            this.headTarget.matrixWorld.decompose(position, headRot, this._tmpV1)\r\n            position.y = 0;\r\n            this.avatar.model.position.copy(position.add(this.data.avatarOffset));\r\n            let head = this.avatar.firstPersonBone;\r\n            if (head) {\r\n                let r = this._tmpQ1.setFromRotationMatrix(head.parent.matrixWorld).invert();\r\n                head.quaternion.copy(headRot.premultiply(r));\r\n            }\r\n        }\r\n        if (this.simpleIK) {\r\n            let pm = this.el.object3D.matrixWorld.clone().invert();\r\n            for (let chain of this.chains) {\r\n                // TODO: add chain.root.position\r\n                let baseMat = chain.root.parent.matrixWorld.clone().premultiply(pm);\r\n                if (this.simpleIK.solve(chain.ikbones, chain.target.position, baseMat) || true) {\r\n                    chain.ikbones.forEach((ikbone, i) => {\r\n                        if (i == chain.ikbones.length - 1) return;\r\n                        let a = ikbone.userData.quaternion.angleTo(ikbone.quaternion);\r\n                        if (a > 0.2) {\r\n                            ikbone.userData.quaternion.slerp(ikbone.quaternion, 0.2 / a);\r\n                        } else {\r\n                            ikbone.userData.quaternion.copy(ikbone.quaternion);\r\n                        }\r\n                    });\r\n\r\n                }\r\n            }\r\n            this.qbinds.forEach(([bone, t, offset]) => {\r\n                let m = offset ? t.matrixWorld.clone().multiply(offset) : t.matrixWorld;\r\n                let r = this._tmpQ0.setFromRotationMatrix(bone.parent.matrixWorld).invert();\r\n                bone.quaternion.copy(this._tmpQ1.setFromRotationMatrix(m).premultiply(r));\r\n            });\r\n        }\r\n    },\r\n    remove() {\r\n        this.el.removeEventListener('model-loaded', this.onVrmLoaded);\r\n        for (let el of this.targetEls) {\r\n            this.el.removeChild(el);\r\n        }\r\n    }\r\n});\r\n"],
  "mappings": "qpBAAO,WAAqC,CASxC,YAAY,EAAkB,CARvB,YAAgC,KAChC,gBAAqB,GAAK,KAAK,GAAK,IAE1B,aAAU,GAAI,OAAM,WACpB,SAAM,GAAI,OAAM,QAAQ,EAAG,EAAG,IAC9B,YAAS,GAAI,OAAM,WACnB,YAAS,GAAI,OAAM,QAGhC,KAAK,MAAQ,EAAQ,MAAM,EAAQ,IAAI,YAAY,iBAGhD,OAAO,EAAiB,CAC3B,GAAI,GAAS,KAAK,OACd,EAAO,KAAK,MAChB,GAAI,GAAU,MAAQ,GAAQ,KAC1B,OAEJ,GAAI,GAAkB,EAAK,aAAa,KAAK,OAAO,sBAAsB,EAAO,cAAc,YAC3F,EAAM,KAAK,OAAO,mBAAmB,KAAK,IAAK,GAC/C,EAAY,KAAK,WACjB,EAAc,IACd,EAAQ,EAAI,KAAK,KAAK,EAAI,GAC9B,AAAI,EAAQ,EAAY,IACpB,GAAM,KAAK,QACX,EAAc,KACP,EAAQ,GACf,EAAI,iBAAiB,KAAK,OAAO,IAAI,EAAI,EAAG,EAAI,EAAG,EAAI,GAAG,YAAa,GAE3E,EAAK,WAAW,MAAM,EAAK,KC5B5B,WAAwB,CAM3B,YAAY,EAAmB,CAJvB,mBAAqB,GAKzB,KAAK,QAAU,EAGZ,oBAAoB,EAAc,EAAqB,CAC1D,KAAK,cAAc,GAAQ,EACvB,GAAS,GACT,MAAO,MAAK,cAAc,GAE9B,KAAK,oBAGF,oBAAoB,EAAsB,CAC7C,MAAO,MAAK,cAAc,IAAS,EAGhC,iBAAkB,CACrB,KAAK,cAAgB,GACrB,KAAK,oBAGF,WAAW,EAA6B,CAC3C,AAAI,KAAK,eAGT,MAAK,cAAgB,CACjB,KAAM,QACN,MAAO,CAAC,EAAG,EAAgB,GAAK,EAAgB,GAAK,GACrD,OAAQ,CAAC,EAAG,EAAG,EAAG,IAEtB,KAAK,qBAGF,WAAkB,CACrB,KAAK,cAAgB,KACrB,KAAK,oBAGD,mBAA0B,CAE9B,GAAI,GAAa,CAAC,EAA2B,EAAc,IAAsB,CAC7E,GAAI,GAAQ,KAAK,QAAQ,YAAY,GACrC,GAAS,EAAM,MAAM,QAAQ,GAAQ,CACjC,GAAI,GAAQ,EAAK,OAAO,KACpB,EAAS,EAAK,IAAW,GAAK,GAAS,GAAI,OAAM,EAAK,OAAO,sBAAsB,OAAS,EAAQ,QAAQ,KAAK,IACrH,OAAS,GAAI,EAAG,EAAI,EAAQ,OAAQ,IAAK,CACrC,GAAI,GAAI,EAAI,EAAK,OAAO,sBAAsB,OAAS,EAAK,MAC5D,EAAO,IAAM,KAAK,IAAI,EAAK,OAAS,EAAQ,GAAI,EAAO,QAI/D,EAAQ,CAAC,GAAI,EAAmC,GACpD,AAAI,KAAK,eACL,GAAQ,KAAK,cAAc,MAC3B,EAAW,EAAW,KAAK,cAAc,KAAM,KAAK,cAAc,SAEtE,OAAS,CAAC,EAAM,IAAU,QAAO,QAAQ,KAAK,eAC1C,AAAI,KAAK,QAAQ,YAAY,IACzB,EAAW,EAAW,EAAM,GAAI,OAAM,EAAM,QAAQ,KAAK,IAGjE,GAAI,GAAS,OAAO,QAAQ,GAAW,IAAI,CAAC,CAAC,EAAO,KAChD,GAAI,OAAM,oBAAoB,EAAQ,yBAA0B,EAAO,IACvE,EAAa,KACjB,GAAI,EAAO,OAAS,EAAG,CACnB,GAAI,GAAO,GAAI,OAAM,cAAc,QAAS,OAAW,GACvD,EAAa,KAAK,QAAQ,MAAM,WAAW,GAAM,mBAAmB,GAAK,OAE7E,KAAK,aAAe,KAAK,YAAY,OACrC,KAAK,YAAc,IC5EpB,WAA0B,CAG7B,YAAY,EAAkB,CAC1B,KAAK,iBAAmB,EAAQ,MAAM,EAAQ,IAAI,YAAY,iBAC9D,KAAK,iBACD,EAAQ,IAAI,YAAY,gBAAgB,IAAI,GAAO,EAAE,KAAM,EAAG,gBAAiB,KAAM,EAAQ,OAAO,EAAG,SAExG,eAAe,EAA4B,CAC9C,KAAK,iBAAiB,QAAQ,GAAK,CAC/B,AAAI,EAAE,MAAQ,kBACV,EAAE,KAAK,QAAU,CAAC,EACf,AAAI,EAAE,MAAQ,kBACjB,EAAE,KAAK,QAAU,EACV,EAAE,MAAQ,QAAU,KAAK,kBAChC,CAAI,EACA,KAAK,oBAAoB,EAAE,MAE3B,KAAK,sBAAsB,EAAE,SAKrC,oBAAoB,EAA+B,CAEvD,GADA,EAAK,SAAS,QAAQ,GAAK,KAAK,oBAAoB,IAChD,CAAC,EAAK,cACN,OAEJ,GAAI,GAA4C,GAChD,KAAK,iBAAiB,SAAS,GAAK,CAChC,EAAiB,EAAE,MAAQ,KAE/B,GAAI,GAAgB,EAAK,SAAS,MAC9B,EAAY,EAAK,SAAS,WAAW,UACrC,EAAa,EAAK,SAAS,WAAW,WACtC,EAAQ,EAAK,SAAS,MACtB,EAAc,GACd,EAAS,EAAG,EAAS,EACzB,OAAS,GAAI,EAAG,EAAI,EAAU,MAAM,OAAQ,IAAK,CAC7C,GAAI,GAAI,EAAU,MAAM,GACxB,AAAI,EAAW,MAAM,GAAK,GAAK,EAAiB,EAAc,GAAG,OACxD,GAAY,EAAI,EAAU,SAAW,IACtC,KACA,EAAY,EAAI,EAAU,SAAW,GAAK,KAItD,GAAI,GAAgB,GACpB,OAAS,GAAI,EAAG,EAAI,EAAM,MAAO,IAC7B,AAAI,EAAY,EAAM,MAAM,KAAO,CAAC,EAAc,EAAI,EAAI,IACtD,GAAc,EAAI,EAAI,GAAK,GAC3B,KAGR,GAAI,GAAU,GAEH,EAAS,GAAK,EAAM,MAAO,CAClC,EAAK,QAAU,GACf,QAIA,sBAAsB,EAA+B,CACzD,EAAK,SAAS,QAAQ,GAAK,KAAK,sBAAsB,IACtD,EAAK,QAAU,KC3DhB,WAAgB,CAEnB,YAAY,EAAkB,CAE1B,KAAK,WAAa,GAAc,GAAI,OAAM,WAAW,MAAM,4BAElD,MAAK,EAAa,EAA4B,GAAwB,CAC/E,MAAO,IAAI,SAAQ,CAAC,EAAS,IAAW,CACpC,KAAK,WAAW,KAAK,EAAK,KAAO,IAAS,CACtC,EAAQ,KAAM,IAAI,GAAU,GAAM,KAAK,EAAM,KAC9C,OAAW,OAKnB,OAAgB,CAwBnB,YAAY,EAAY,CArBR,WAAoC,GAC7C,iBAA8E,GACrE,aAAqC,GAC9C,UAA4B,GAG5B,qBAAqC,KAEpC,0BAAmD,KAIpD,qBAAkB,CACrB,KAAQ,CAAE,KAAM,OAAQ,MAAO,GAAK,KAAK,GAAK,IAAK,UAAW,GAAI,OAAM,QAAQ,EAAG,EAAG,GAAI,WAAY,GAAK,KAAK,GAAK,KACrH,KAAQ,CAAE,KAAM,OAAQ,MAAO,GAAK,KAAK,GAAK,IAAK,UAAW,GAAI,OAAM,QAAQ,EAAG,EAAG,GAAI,WAAY,GAAK,KAAK,GAAK,KACrH,aAAgB,CAAE,KAAM,OAAQ,MAAO,IAAM,KAAK,GAAK,IAAK,UAAW,GAAI,OAAM,QAAQ,EAAG,GAAI,GAAI,WAAY,KAAK,GAAK,GAC1H,cAAiB,CAAE,KAAM,OAAQ,MAAO,IAAM,KAAK,GAAK,IAAK,UAAW,GAAI,OAAM,QAAQ,EAAG,GAAI,GAAI,WAAY,KAAK,GAAK,GAC3H,aAAgB,CAAE,KAAM,QAAS,KAAM,GAAI,OAAM,QAAQ,EAAG,EAAG,GAAI,IAAK,KAAO,KAAK,GAAK,IAAK,IAAK,EAAI,KAAK,GAAK,KACjH,cAAiB,CAAE,KAAM,QAAS,KAAM,GAAI,OAAM,QAAQ,EAAG,EAAG,GAAI,IAAK,KAAO,KAAK,GAAK,IAAK,IAAK,EAAI,KAAK,GAAK,MAIlH,KAAK,MAAQ,EAAK,MAClB,KAAK,MAAQ,GAAI,OAAM,eAAe,KAAK,OAC3C,KAAK,MAAS,GAAK,SAAS,gBAAkB,IAAI,KAAO,KACzD,KAAK,WAAa,EAAK,YAAc,GACrC,KAAK,gBAAkB,GAAI,GAAkB,WAGpC,MAAK,EAAY,EAA2B,CACrD,GAAI,CAAC,KAAK,MACN,MAAO,MAEX,GAAI,GAAS,EAAK,SAAS,eAAe,IACtC,EAAQ,KAAK,MACb,EAAQ,KAAM,GAAK,OAAO,gBAAgB,QAC1C,EAAS,KAAM,GAAK,OAAO,gBAAgB,QAC3C,EAAU,CAAE,MAAO,EAAO,OAAQ,EAAQ,IAAK,EAAQ,KAAM,GAEjE,KAAK,KAAO,EAAO,KACnB,OAAO,OAAO,EAAO,SAAS,YAAY,QAAQ,AAAC,GAAc,CAC7D,EAAM,EAAU,MAAQ,EAAM,EAAU,QAExC,EAAO,aACH,GAAO,YAAY,iBACnB,MAAK,gBAAkB,EAAM,EAAO,YAAY,iBAChD,KAAK,QAAQ,OAAS,GAAI,GAAU,IAEpC,EAAO,YAAY,iBACnB,MAAK,qBAAuB,GAAI,GAAoB,KAG5D,KAAK,MAAM,SAAW,GAAI,OAAM,SAAS,OAAO,OAAO,IACvD,KAAK,kBACD,EAAO,kBACP,KAAK,iBAAiB,GAG1B,OAAS,KAAQ,GAAa,CAC1B,GAAI,GAAM,EAAK,YAAY,KAAM,GACjC,AAAI,GACA,MAAK,QAAQ,EAAK,MAAQ,GAGlC,MAAO,MAEH,iBAAiB,EAAoB,CACzC,KAAK,YAAe,GAAI,IAAI,iBAAiB,kBAAoB,IAAI,OAAO,CAAC,EAAkC,IAAO,CAClH,GAAI,GAAQ,EAAG,MAAM,QAAQ,GAAQ,CACjC,GAAI,GAAU,EAAI,OAAO,EAAK,MAC9B,MAAQ,GAAQ,cAAgB,CAAC,GAAW,EAAQ,SAAS,OAAO,GAA2B,EAAK,gBAC/F,IAAI,GAAQ,EAAE,OAAQ,EAAK,MAAO,EAAK,MAAO,OAAQ,EAAK,OAAS,SAE7E,SAAa,GAAG,YAAc,EAAG,MAAM,eAAiB,CAAE,KAAM,EAAG,KAAM,MAAO,GACzE,GACR,IAEC,iBAAwB,CAC5B,GAAI,GAAQ,KAAK,MACjB,GAAI,CAAC,EAAM,KACP,OAGJ,GAAI,GAAO,GAAI,OAAM,QACjB,EAAS,EAAM,KAAK,iBAAiB,GAAM,QAC/C,KAAK,MAAM,SAAS,AAAC,GAAQ,CACzB,GAAI,GAA0B,EAC9B,GAAI,EAAK,cAAe,CACpB,GAAI,GAAM,EAAK,iBAAiB,GAAM,IAAI,GAAQ,eAAe,IAC7D,EAAK,EAAI,QAAQ,IAAI,EAAK,SAAS,eAAgB,QAAQ,SAAW,EAAK,SAAS,eAAgB,OACxG,EAAK,SAAS,eAAgB,OAAO,KAAK,GAC1C,EAAK,SAAS,eAAgB,OAAS,EACvC,EAAK,SAAS,YAAa,IAAI,IAAI,EAAI,EAAI,EAAG,EAAI,EAAI,EAAG,EAAI,EAAI,GACjE,EAAK,SAAS,YAAa,IAAI,IAAI,EAAI,EAAI,EAAG,EAAI,EAAI,EAAG,EAAI,EAAI,MAItE,OAAO,EAAyB,CACnC,KAAK,MAAM,OAAO,GAClB,OAAS,KAAK,QAAO,OAAO,KAAK,SAC7B,EAAE,OAAO,GAGV,UAAU,EAAc,EAAyB,CACpD,KAAK,aAAa,GAClB,KAAK,QAAQ,GAAQ,EAElB,aAAa,EAAoB,CACpC,GAAI,GAAS,KAAK,QAAQ,GAC1B,GAAU,EAAO,SAAW,EAAO,UACnC,MAAO,MAAK,QAAQ,GAEjB,SAAgB,CACnB,OAAS,KAAK,QAAO,KAAK,KAAK,SAC3B,KAAK,aAAa,GAEtB,KAAK,MAAM,SAAS,AAAC,GAAQ,CACzB,GAAI,GAAO,EACX,AAAI,EAAK,QACL,GAAK,SAAS,UACb,EAAK,SAAqC,KAAK,WAGpD,EAAI,UAAY,EAAI,SAAS,eAKjC,eAAsC,CACtC,GAAI,GAAS,KAAK,QAAQ,OAC1B,MAAO,GAAS,EAAO,OAAS,QAEhC,cAAa,EAAmB,CAChC,GAAI,GAAS,KAAK,QAAQ,OAC1B,AAAI,GACA,GAAO,OAAS,GAGjB,oBAAoB,EAAc,EAAqB,CAC1D,KAAK,gBAAgB,oBAAoB,EAAM,GAE5C,oBAAoB,EAAsB,CAC7C,MAAO,MAAK,gBAAgB,oBAAoB,GAE7C,iBAAwB,CAC3B,KAAK,gBAAgB,kBAElB,WAAW,EAA6B,CAC3C,KAAK,gBAAgB,WAAW,GAE7B,WAAkB,CACrB,KAAK,gBAAgB,YAElB,QAAQ,EAAgC,CAC3C,GAAI,GAAqB,CACrB,MAAO,OAAO,KAAK,KAAK,OAAO,IAAI,AAAC,GAC/B,EAAE,KAAM,EAAM,EAAG,KAAK,MAAM,GAAM,WAAW,cAGtD,MAAI,IACA,GAAS,WAAa,OAAO,KAAK,KAAK,aAAa,IAAI,AAAC,GACpD,EAAE,KAAM,EAAM,MAAO,KAAK,oBAAoB,OAGhD,EAEJ,QAAQ,EAAsB,CACjC,GAAI,EAAK,MACL,OAAS,KAAa,GAAK,MACvB,AAAI,KAAK,MAAM,EAAU,OACrB,KAAK,MAAM,EAAU,MAAM,WAAW,UAAU,EAAU,GAItE,GAAI,EAAK,WACL,OAAS,KAAS,GAAK,WACnB,KAAK,oBAAoB,EAAM,KAAM,EAAM,OAIhD,UAAiB,CACpB,OAAS,KAAK,QAAO,OAAO,KAAK,OAC7B,EAAE,WAAW,IAAI,EAAG,EAAG,EAAG,GAG3B,eAAe,EAA4B,CAC9C,AAAI,KAAK,sBACL,KAAK,qBAAqB,eAAe,KCnN9C,WAA8C,CAajD,YAAY,EAAkB,CAZ9B,oBAAiB,EACjB,YAAS,GACT,WAAyC,GACzC,gBAA8C,GAC9C,YAAwB,GACxB,iBAAqB,GACJ,YAAS,GAAI,OAAM,WACnB,YAAS,GAAI,OAAM,QACnB,YAAS,GAAI,OAAM,QAEpC,WAA6B,KAC7B,mBAAyB,GAErB,KAAK,iBAAmB,KAAK,oBAC7B,KAAK,MAAM,GAEP,MAAM,EAAwB,CAClC,GAAI,CAAC,EAAQ,IAAI,mBACb,OAEJ,GAAI,GAAQ,EAAQ,MAChB,EAAqB,EAAQ,IAAI,mBACjC,EAAwB,EACxB,EAAuB,GAC3B,AAAC,GAAmB,gBAAkB,IAAI,QAAQ,CAAC,EAAI,IAAM,CACzD,GAAI,GAAO,EAAM,EAAG,MACpB,OAAS,KAAY,GAAG,UAAW,CAC/B,GAAI,GAAO,GAAI,QAAO,KAAK,CAAE,KAAM,EAAG,qBAAsB,GAAM,KAAK,eAAiB,EAAI,EAAI,oBAAqB,KACrH,EAAK,SAAS,GAAI,QAAO,OAAO,EAAS,OAAS,GAAuB,EAAS,QAClF,KAAK,OAAO,KAAK,GACjB,KAAK,WAAW,KAAK,CAAC,EAAM,IAC5B,GAAyB,EAAK,wBAGtC,OAAS,KAAM,GAAmB,YAAc,GAAI,CAChD,GAAI,GAAU,GAAI,QAAO,OAAO,KAAK,EAAG,YAAc,CAAE,EAAG,EAAG,EAAG,GAAI,EAAG,IAAK,MAAM,EAAG,cAAgB,GAClG,EAAS,EAAG,WAAa,IACzB,EAAsB,CAAE,MAAK,eAAiB,GAClD,OAAS,KAAK,GAAG,gBAAkB,GAC/B,GAAuB,GAAM,KAAK,eAAiB,EAAI,EAE3D,OAAS,KAAK,GAAG,MAAO,CACpB,GAAI,GAAO,GAAI,QAAO,KAAK,CAAE,KAAM,EAAG,qBAAsB,EAAG,oBAAqB,IACpF,EAAK,SAAS,KAAK,EAAM,GAAG,OAAO,iBAAiB,KAAK,SACzD,KAAK,OAAO,KAAK,GACjB,KAAK,WAAW,KAAK,CAAC,EAAM,GAAG,OAAQ,IACvC,GAAI,GAAM,CAAC,EAAyB,IAAyB,CACzD,GAAI,GAAI,EAAK,iBAAiB,KAAK,QAC/B,EAAO,EAAE,QACT,EAAI,EAAK,SAAS,OAAS,EAC/B,AAAI,EAAK,SAAS,OAAS,EACvB,EAAK,SAAS,QAAQ,GAAK,CACvB,EAAE,IAAI,EAAE,iBAAiB,KAAK,WAGlC,GAAE,IAAI,EAAK,OAAQ,iBAAiB,KAAK,QAAQ,IAAI,GAAG,YAAY,eAAe,KAAM,IAAI,IAC7F,EAAI,GAER,EAAE,eAAe,EAAI,GAErB,GAAI,GAAO,GAAI,QAAO,KAAK,CACvB,KAAM,GACN,cAAe,KAAK,IAAI,EAAG,WAAa,EAAG,MAC3C,eAAgB,KAAK,IAAI,EAAG,WAAa,EAAG,MAC5C,qBAAsB,KAAK,eAC3B,oBAAqB,EACrB,SAAU,GAAI,QAAO,OAAO,KAAK,KAErC,EAAK,SAAS,GAAI,QAAO,OAAO,IAChC,KAAK,OAAO,KAAK,GAEjB,GAAI,GAAI,GAAI,QAAO,OAAO,KAAK,KAAK,OAAO,KAAK,GAAM,IAAI,IACtD,EAAI,GAAI,QAAO,OAAO,KAAK,EAAK,IAAI,EAAW,WAC/C,EAAQ,GAAI,QAAO,uBAAuB,EAAM,EAAG,EAAY,GACnE,KAAK,YAAY,KAAK,GAEtB,KAAK,MAAM,KAAK,CAAC,EAAM,IACvB,KAAK,iBAAiB,QAAQ,KAAK,CAAE,KAAM,EAAM,WAAY,EAAY,MAAO,EAAS,UAAW,EAAI,KAAM,IAC9G,EAAK,SAAS,QAAQ,GAAM,EAAiB,QAAU,EAAI,EAAM,KAErE,EAAI,EAAM,EAAM,MAIpB,mBAAoB,CACxB,GAAI,GAAM,GAAI,QAAO,WACjB,EAAM,GAAI,QAAO,WACjB,EAAM,GAAI,QAAO,KACrB,MAAO,CACH,MAAO,KACP,QAAS,GACT,QAAS,CACL,GAAI,GAAI,KAAK,MAAO,QAAS,EAAK,KAAK,MAAO,GAC1C,EAAU,GACd,OAAS,KAAK,MAAK,QAAS,CACxB,GAAI,GAAO,EAAE,KAAM,EAAS,EAAE,WAE1B,EAAI,EAAK,MAAO,EAAI,EAAK,KAAM,EAAK,EAAE,MAC1C,EAAE,GAAK,EAAK,EAAC,EAAE,EAAI,EAAG,GACtB,EAAE,GAAK,EAAK,EAAC,EAAE,EAAI,EAAG,GACtB,EAAE,GAAK,EAAK,EAAC,EAAE,EAAI,EAAG,GAGtB,GAAI,GAAK,EAAK,gBAAgB,SAC9B,AAAI,EAAK,GACL,EAAK,gBAAgB,MAAM,EAAU,EAAI,EAAK,iBAIlD,GAAI,GAAY,EAAE,UAAU,WACxB,EAAgB,EAAE,KAAO,EAAE,KAAO,EAAI,KACtC,EAAM,EAAK,WAAW,KAAK,EAAO,WAAW,QAAQ,GAAM,GAC3D,CAAC,EAAM,GAAS,EAAI,YAAY,GACpC,EAAQ,EAAQ,KAAK,GAAK,EAAI,KAAK,MAAO,GAAQ,KAAK,IAAO,MAAK,GAAK,IACxE,GAAI,GAAK,EAAQ,EACjB,AAAI,KAAK,IAAI,GAAM,KAAK,IAAI,EAAQ,EAAK,EAAK,QAC1C,GAAK,EAAQ,EAAK,EAAK,OAE3B,GAAI,GAAK,EAAK,MAAM,CAAC,EAAK,EAAe,GACzC,EAAK,OAAO,KAAK,EAAI,EAAK,WAKnC,OAAO,EAAkC,CAC5C,KAAK,SACL,KAAK,cAAgB,GAAS,KAC9B,KAAK,MAAQ,GAAS,GAAI,QAAO,MACjC,KAAK,iBAAiB,MAAQ,KAAK,MACnC,KAAK,MAAM,WAAW,KAAK,KAAK,kBAChC,KAAK,OAAO,QAAQ,GAAK,KAAK,MAAO,QAAQ,IAC7C,KAAK,YAAY,QAAQ,GAAK,KAAK,MAAO,cAAc,IACxD,KAAK,QACL,KAAK,OAAS,GAEd,KAAK,MAAM,OAAO,QAAQ,GAAK,CAC3B,AAAI,EAAE,sBAAwB,GAAK,EAAE,qBAAuB,GACxD,GAAE,oBAAsB,MAI7B,QAAe,CAClB,AAAI,CAAC,KAAK,OAGV,MAAK,MAAM,WAAa,KAAK,MAAM,WAAW,OAAO,GAAK,GAAK,KAAK,kBACpE,KAAK,MAAM,YAAc,KAAK,MAAM,YAAY,OAAO,GAAK,CAAC,KAAK,YAAY,SAAS,IACvF,KAAK,MAAM,OAAS,KAAK,MAAM,OAAO,OAAO,GAAK,CAAC,KAAK,OAAO,SAAS,IACxE,KAAK,MAAQ,KACb,KAAK,OAAS,IAEX,OAAc,CACjB,KAAK,WAAW,QAAQ,CAAC,CAAC,EAAM,KAAU,CACtC,EAAK,kBAAkB,GAAM,IAC7B,EAAK,SAAS,KAAK,EAAK,iBAAiB,KAAK,SAC9C,EAAK,WAAW,KAAK,EAAK,OAAQ,mBAAmB,KAAK,WAE9D,KAAK,MAAM,QAAQ,CAAC,CAAC,EAAM,KAAU,CACjC,EAAK,kBAAkB,GAAM,IAC7B,EAAK,SAAS,KAAK,EAAK,iBAAiB,KAAK,SAC9C,EAAK,WAAW,KAAK,EAAK,mBAAmB,KAAK,WAGnD,OAAO,EAAyB,CACnC,AAAI,CAAC,KAAK,QAGV,MAAK,WAAW,QAAQ,CAAC,CAAC,EAAM,KAAU,CACtC,EAAK,SAAS,KAAK,EAAK,iBAAiB,KAAK,SAC9C,EAAK,WAAW,KAAK,EAAK,mBAAmB,KAAK,WAElD,KAAK,eACL,KAAK,MAAO,KAAK,EAAI,GAAI,GAE7B,KAAK,MAAM,QAAQ,CAAC,CAAC,EAAM,KAAU,CACjC,EAAK,WAAW,KAAK,EAAK,YAAY,YAAY,EAAK,OAAQ,mBAAmB,KAAK,QAAQ,aAGhG,SAAgB,CACnB,KAAK,WCnLN,WAAa,CAShB,YAAY,EAAyB,EAAoC,EAAe,CAJxF,gBAAa,GAAI,OAAM,WACvB,iBAAc,GAAI,OAAM,QACxB,mBAAgB,GAAI,OAAM,QAGtB,KAAK,SAAW,EAChB,KAAK,WAAa,EAClB,KAAK,SAAW,IAGjB,OAAe,CAAf,aAhBP,CAiBI,oBAAiB,GACjB,iBAAc,KACd,SAAM,GAAI,OAAM,QAAQ,EAAG,EAAG,GAC9B,YAAS,GAAI,OAAM,QACnB,YAAS,GAAI,OAAM,QACnB,YAAS,GAAI,OAAM,QACnB,YAAS,GAAI,OAAM,WACnB,YAAS,GAAI,OAAM,WAEnB,aAAa,EAAiB,EAA0B,CACpD,OAAS,KAAQ,GACb,EAAK,YAAY,QAAQ,EAAK,SAAU,EAAK,WAAY,KAAK,KAAK,YAAY,GAC/E,EAAK,cAAc,sBAAsB,EAAK,aAC9C,EAAY,EAAK,YAGzB,MAAM,EAAiB,EAAuB,EAA6B,CACvE,KAAK,aAAa,EAAO,GACzB,GAAI,GAAc,EAAM,EAAM,OAAS,GAAG,cACtC,EAAgB,EAAY,kBAAkB,GAC9C,EAAY,KAAK,OACjB,EAAS,KAAK,OACd,EAAW,KAAK,OACpB,OAAS,GAAI,EAAG,EAAI,KAAK,gBACjB,IAAY,kBAAkB,GAAU,KAAK,aADZ,IAAK,CAI1C,GAAI,GAAgB,KAAK,OAAO,KAAK,GACrC,OAAS,GAAI,EAAM,OAAS,EAAG,GAAK,EAAG,IAAK,CACxC,GAAI,GAAO,EAAM,GACb,EAAS,EAAM,EAAI,GAAG,SAC1B,EAAK,YAAY,UAAU,KAAK,OAAQ,KAAK,OAAQ,KAAK,QAC1D,EAAU,KAAK,GAAe,IAAI,KAAK,QAAQ,gBAAgB,EAAS,KAAK,KAAK,QAAQ,UAAU,YACpG,EAAO,KAAK,GAAQ,YACpB,EAAS,mBAAmB,EAAQ,GACpC,EAAK,WAAW,SAAS,GACzB,GAAI,GAAI,EAAO,KAAK,GAAQ,gBAAgB,KAAK,OAAO,SAAS,IACjE,AAAI,EAAK,YACL,GAAS,KAAK,EAAK,YAAY,SAC3B,EAAK,WAAW,MAAM,IAEtB,GAAS,YAAY,EAAK,YAC1B,EAAE,KAAK,GAAQ,gBAAgB,KAAK,OAAO,SAAS,MAG5D,EAAc,IAAI,GAEtB,KAAK,aAAa,EAAO,GAE7B,MAAO,GAAY,kBAAkB,GAAU,IChEhD,WAAuB,CAAvB,aAFP,CAGI,iBAAuD,CACnD,CAAE,KAAQ,OAAQ,UAAa,CAAC,2BAAQ,WACxC,CAAE,KAAQ,QAAS,UAAa,CAAC,qBAAO,eACxC,CAAE,KAAQ,QAAS,UAAa,CAAC,sBAAQ,gBACzC,CAAE,KAAQ,OAAQ,UAAa,CAAC,SAAK,SACrC,CAAE,KAAQ,OAAQ,UAAa,CAAC,SAAK,SACrC,CAAE,KAAQ,eAAgB,UAAa,CAAC,eAAM,eAC9C,CAAE,KAAQ,eAAgB,UAAa,CAAC,eAAM,UAC9C,CAAE,KAAQ,eAAgB,UAAa,CAAC,qBAAO,YAC/C,CAAE,KAAQ,WAAY,UAAa,CAAC,qBAAO,YAC3C,CAAE,KAAQ,gBAAiB,UAAa,CAAC,eAAM,eAC/C,CAAE,KAAQ,gBAAiB,UAAa,CAAC,eAAM,UAC/C,CAAE,KAAQ,gBAAiB,UAAa,CAAC,qBAAO,YAChD,CAAE,KAAQ,YAAa,UAAa,CAAC,qBAAO,YAC5C,CAAE,KAAQ,eAAgB,UAAa,CAAC,eAAM,UAC9C,CAAE,KAAQ,eAAgB,UAAa,CAAC,qBAAO,WAC/C,CAAE,KAAQ,WAAY,UAAa,CAAC,qBAAO,YAC3C,CAAE,KAAQ,WAAY,UAAa,CAAC,2BAAQ,UAC5C,CAAE,KAAQ,gBAAiB,UAAa,CAAC,eAAM,UAC/C,CAAE,KAAQ,gBAAiB,UAAa,CAAC,qBAAO,WAChD,CAAE,KAAQ,YAAa,UAAa,CAAC,qBAAO,YAC5C,CAAE,KAAQ,YAAa,UAAa,CAAC,2BAAQ,UAC7C,CAAE,KAAQ,UAAW,UAAa,CAAC,eAAM,UACzC,CAAE,KAAQ,WAAY,UAAa,CAAC,eAAM,UAC1C,CAAE,KAAQ,oBAAqB,UAAa,CAAC,2BAAQ,aACrD,CAAE,KAAQ,wBAAyB,UAAa,CAAC,2BAAQ,aACzD,CAAE,KAAQ,kBAAmB,UAAa,CAAC,2BAAQ,aACnD,CAAE,KAAQ,oBAAqB,UAAa,CAAC,2BAAQ,YACrD,CAAE,KAAQ,wBAAyB,UAAa,CAAC,2BAAQ,YACzD,CAAE,KAAQ,kBAAmB,UAAa,CAAC,2BAAQ,YACnD,CAAE,KAAQ,qBAAsB,UAAa,CAAC,2BAAQ,cACtD,CAAE,KAAQ,yBAA0B,UAAa,CAAC,2BAAQ,cAC1D,CAAE,KAAQ,mBAAoB,UAAa,CAAC,2BAAQ,cACpD,CAAE,KAAQ,mBAAoB,UAAa,CAAC,2BAAQ,aACpD,CAAE,KAAQ,uBAAwB,UAAa,CAAC,2BAAQ,aACxD,CAAE,KAAQ,iBAAkB,UAAa,CAAC,2BAAQ,aAClD,CAAE,KAAQ,qBAAsB,UAAa,CAAC,2BAAQ,cACtD,CAAE,KAAQ,yBAA0B,UAAa,CAAC,2BAAQ,cAC1D,CAAE,KAAQ,mBAAoB,UAAa,CAAC,2BAAQ,cACpD,CAAE,KAAQ,qBAAsB,UAAa,CAAC,2BAAQ,aACtD,CAAE,KAAQ,yBAA0B,UAAa,CAAC,2BAAQ,aAC1D,CAAE,KAAQ,mBAAoB,UAAa,CAAC,2BAAQ,aACpD,CAAE,KAAQ,qBAAsB,UAAa,CAAC,2BAAQ,YACtD,CAAE,KAAQ,yBAA0B,UAAa,CAAC,2BAAQ,YAC1D,CAAE,KAAQ,mBAAoB,UAAa,CAAC,2BAAQ,YACpD,CAAE,KAAQ,sBAAuB,UAAa,CAAC,2BAAQ,cACvD,CAAE,KAAQ,0BAA2B,UAAa,CAAC,2BAAQ,cAC3D,CAAE,KAAQ,oBAAqB,UAAa,CAAC,2BAAQ,cACrD,CAAE,KAAQ,oBAAqB,UAAa,CAAC,2BAAQ,aACrD,CAAE,KAAQ,wBAAyB,UAAa,CAAC,2BAAQ,aACzD,CAAE,KAAQ,kBAAmB,UAAa,CAAC,2BAAQ,aACnD,CAAE,KAAQ,sBAAuB,UAAa,CAAC,2BAAQ,cACvD,CAAE,KAAQ,0BAA2B,UAAa,CAAC,2BAAQ,cAC3D,CAAE,KAAQ,oBAAqB,UAAa,CAAC,2BAAQ,eAEzD,mBAAgB,CACZ,EAAK,SACL,EAAK,SACL,EAAK,SACL,EAAK,SACL,EAAK,SACL,MAAS,4BAEb,qBAAkB,CACd,aAAgB,IAAM,MAAM,UAAU,QACtC,cAAiB,GAAK,MAAM,UAAU,SAE1C,eAAY,CACR,CAAE,OAAQ,2BAAQ,MAAO,CAAC,WAAY,eAAgB,iBACtD,CAAE,OAAQ,2BAAQ,MAAO,CAAC,YAAa,gBAAiB,kBACxD,CAAE,OAAQ,uCAAU,OAAQ,EAAG,MAAO,CAAC,WAAY,aACnD,CAAE,OAAQ,uCAAU,OAAQ,EAAG,MAAO,CAAC,YAAa,eAExD,qBAAuC,CACnC,aAAgB,CAAE,IAAK,GAAI,OAAM,QAAQ,KAAO,KAAK,GAAK,IAAK,EAAG,GAAI,IAAK,GAAI,OAAM,QAAQ,EAAG,EAAG,IACnG,cAAiB,CAAE,IAAK,GAAI,OAAM,QAAQ,KAAO,KAAK,GAAK,IAAK,EAAG,GAAI,IAAK,GAAI,OAAM,QAAQ,EAAG,EAAG,IACpG,aAAgB,CAAE,IAAK,GAAI,OAAM,QAAQ,CAAC,KAAK,GAAK,EAAG,CAAC,KAAK,GAAK,EAAG,CAAC,KAAK,GAAK,GAAI,IAAK,GAAI,OAAM,QAAQ,KAAK,GAAI,KAAK,GAAK,EAAG,KAAK,GAAK,IAC3I,cAAiB,CAAE,IAAK,GAAI,OAAM,QAAQ,CAAC,KAAK,GAAK,EAAG,CAAC,KAAK,GAAK,EAAG,CAAC,KAAK,GAAK,GAAI,IAAK,GAAI,OAAM,QAAQ,KAAK,GAAI,KAAK,GAAK,EAAG,KAAK,GAAK,UAG1I,MAAK,EAAa,EAAgB,EAA4C,CAEhF,GAAI,CAAE,aAAc,KAAM,QAAO,yDAE7B,CAAE,eAAgB,KAAM,QAAO,6DAC/B,EAAS,GAAI,GAEb,EAAkC,GACtC,OAAS,KAAK,MAAK,YAAa,CAC5B,GAAI,GAAU,EAAI,MAAM,EAAE,MAC1B,GAAI,EACA,OAAS,KAAQ,GAAE,UACf,EAAQ,GAAQ,EAAQ,KAIpC,GAAI,GAAoD,GACpD,EAAmD,GACvD,OAAS,CAAC,EAAM,IAAM,QAAO,QAAQ,KAAK,iBAAkB,CACxD,GAAI,GAAU,EAAI,MAAM,GACxB,AAAI,GACA,GAAgB,EAAQ,MAAQ,GAAI,OAAM,aAAa,iBAAiB,GAAI,OAAM,QAAQ,EAAG,EAAG,GAAI,GACpG,EAAQ,SAAS,GAAK,CAClB,EAAe,EAAE,MAAQ,CAAC,KAAK,IAAI,GAAI,KAAK,IAAI,OAI5D,GAAI,GAAgD,GACpD,OAAS,CAAC,EAAM,IAAU,QAAO,QAAQ,KAAK,eAE1C,AAAI,AADI,EAAI,YAAY,IAEpB,GAAsB,GAAS,GAKvC,EAAI,MAAM,sBAAwB,EAClC,GAAI,GAAQ,IACR,EAAO,CAAC,EAAa,IAAgB,CACrC,CAAC,EAAE,GAAI,EAAE,IAAM,CACX,EAAE,GAAK,EAAE,GAAK,EAAE,GAAK,EAAE,GACvB,EAAE,GAAK,EAAE,GAAK,EAAE,GAAK,EAAE,KAG3B,EAAO,CAAC,EAAa,IAAgB,CACrC,CAAC,EAAE,GAAI,EAAE,IAAM,CACX,EAAE,GAAK,EAAE,GAAK,EAAE,GAAK,EAAE,GACvB,EAAE,GAAK,EAAE,GAAK,EAAE,GAAK,EAAE,KAG3B,EAAM,GAAI,OAAM,WAChB,EAAO,GAAI,OAAM,WACrB,MAAO,MAAM,IAAI,SAAQ,CAAC,EAAS,IAAW,CAC1C,EAAO,QAAQ,EAAK,KAAO,IAA4B,CAEnD,GAAI,GAAY,EAAI,QAAQ,OAAO,GAAK,EAAE,UAAY,sBACtD,GAAI,EAAU,OAAQ,CAClB,EAAU,KAAK,CAAC,EAAG,IAAM,EAAE,SAAW,EAAE,UACxC,GAAI,GAAS,CAAC,EAAe,IAAiB,CAC1C,EAAO,KAAK,CAAC,EAAG,IAAM,EAAE,SAAW,EAAE,UACrC,GAAI,GAAI,EACR,OAAS,KAAK,GAAQ,CAClB,KAAO,EAAI,EAAU,OAAS,GAAK,EAAE,SAAW,EAAU,GAAG,UACzD,IAEJ,GAAI,GAAI,EAAK,UAAU,EAAU,GAAG,UACpC,GAAI,EAAI,GAAK,EAAE,SAAW,EAAU,GAAG,SAAU,CAC7C,GAAI,GAAK,GAAE,SAAW,EAAU,EAAI,GAAG,UAAa,GAAU,GAAG,SAAW,EAAU,EAAI,GAAG,UAE7F,EAAE,MAAM,EAAI,UAAU,EAAU,EAAI,GAAG,UAAW,EAAI,GAE1D,AAAI,GAAK,EAAE,SACX,EAAE,SAAW,EAAI,UAAU,EAAE,UAAU,SAAS,GAAG,YAG3D,EAAO,EAAI,QAAQ,OAAO,GAAK,EAAE,UAAY,4BAAS,IACtD,EAAO,EAAI,QAAQ,OAAO,GAAK,EAAE,UAAY,sBAAQ,IACrD,EAAU,QAAQ,GAAK,EAAE,SAAW,CAAC,EAAG,EAAG,EAAG,IAGlD,OAAS,KAAK,GAAI,QAAS,CACvB,AAAI,EAAQ,EAAE,WACV,GAAE,SAAW,EAAQ,EAAE,WAE3B,GAAI,GAAI,EAAgB,EAAE,UAC1B,AAAI,GACA,GAAE,SAAW,EAAI,UAAU,EAAE,UAAU,YAAY,GAAG,WAE1D,EAAE,SAAS,IAAM,EACjB,EAAE,SAAS,IAAM,EACjB,EAAE,SAAS,IAAM,EACjB,EAAK,EAAE,SAAU,CAAC,GAAI,IACtB,EAAK,EAAE,SAAU,CAAC,GAAI,IACtB,GAAI,GAAI,EAAe,EAAE,UACzB,AAAI,GACA,GAAK,EAAE,SAAU,GACjB,EAAK,EAAE,SAAU,IAIzB,GAAI,EAAQ,SAAU,CAGlB,GAAI,GAAgB,EAAI,MAAM,SAAS,MACnC,EAAgB,AAAC,GAA2D,CAC5E,GAAI,GAAc,EAAc,UAAU,GAAK,EAAE,MAAQ,EAAO,QAChE,GAAI,GAAe,EACf,MAAO,GAEX,GAAI,GAAY,EAAO,QAAU,KAAO,EAAc,EAAc,KAAK,UAAU,EAAO,UAAY,EAAI,MACtG,EAAY,GAAI,OAAM,KAC1B,EAAU,KAAO,EAAO,OACxB,EAAc,KAAK,GACnB,EAAU,IAAI,GACd,EAAU,oBACV,GAAI,GAAU,EAAI,MAAM,EAAO,MAAM,IAAI,iBAAiB,GAAI,OAAM,SACpE,SAAU,SAAS,KAAK,EAAQ,aAAa,EAAU,YAAY,QAAQ,WASpE,EAAc,OAAS,GAE9B,EAAM,GACV,OAAS,KAAU,MAAK,UAAW,CAE/B,GAAI,EAAI,QAAQ,KAAK,GAAK,EAAE,UAAY,EAAO,SAAW,KACtD,SAEJ,GAAI,GAAY,AAAC,GAAiB,EAAc,UAAU,GAAK,GAAK,EAAI,MAAM,IAC1E,EAAgB,EAAU,EAAO,MAAM,IAC3C,GAAI,EAAgB,EAChB,SAEJ,GAAI,GAAe,GACnB,EAAO,MAAM,MAAM,GAAG,QAAQ,GAAQ,CAClC,GAAI,GAAQ,EAAU,GACtB,GAAI,GAAS,EAAG,CACZ,GAAI,GAAgE,CAAE,MAAO,GACzE,EAAa,KAAK,gBAAgB,GACtC,AAAI,GACA,GAAK,YAAc,EAAW,IAC9B,EAAK,YAAc,EAAW,KAElC,EAAM,KAAK,MAGnB,GAAI,GAAK,CACL,OAAQ,EAAc,GACtB,SAAU,EACV,MAAO,EACP,SAAU,EACV,UAAW,GAEf,EAAI,KAAK,GAEb,GAAI,EAAI,OAAS,EAAG,CAChB,QAAQ,IAAI,GACZ,GAAI,GAAW,GAAI,GAAY,EAAI,MAAO,GAC1C,EAAI,UAAU,QAAS,CAAE,OAAQ,AAAC,GAAM,EAAS,YAIzD,GAAI,GAAO,EAAO,iBAAiB,MAAM,EAAK,EAAI,OAClD,EAAK,OAAO,QAAQ,GAAM,CACtB,GAAI,GAAI,EAAG,KAAK,MAAM,mCACtB,GAAI,EAAG,CACH,GAAI,GAAI,EAAI,YAAY,EAAE,IAC1B,AAAI,GAAK,EAAE,MAAM,OAAS,GAEtB,GAAG,KAAO,EAAE,MAAM,GAAG,OAAO,KAAO,0BAA4B,EAAE,MAAM,GAAG,MAAQ,QAI9F,EAAQ,IACT,IAAM,GAAK,OCpQnB,WAAuB,MACb,MAAK,EAAa,EAAmB,EAA4C,CAE1F,GAAI,CAAE,aAAc,KAAM,QAAO,yDACjC,MAAO,MAAM,IAAI,SAAQ,CAAC,EAAS,IAAW,CAC1C,GAAI,KAAY,KAAK,EAAK,AAAC,GAAgB,CACvC,AAAI,EAAQ,aACR,KAAK,aAAa,EAAO,KAAM,GAEnC,EAAO,KAAK,OAAS,EAAO,KAAK,OAAO,OAAO,AAAC,GAAW,CAAC,EAAE,KAAK,MAAM,aAAe,EAAE,KAAK,MAAM,EAAO,MAAM,KAAK,OACvH,EAAQ,EAAO,UAKjB,gBAAgB,EAAsB,CAC5C,SAAO,EAAK,QAAQ,QAAS,QAC7B,EAAO,EAAK,QAAQ,SAAU,SAC9B,EAAO,EAAK,QAAQ,SAAU,cAC9B,EAAO,EAAK,QAAQ,QAAS,YAC7B,EAAO,EAAK,QAAQ,UAAW,gBAC/B,EAAO,EAAK,QAAQ,WAAY,iBAChC,EAAO,EAAK,QAAQ,UAAW,YAC/B,EAAO,EAAK,QAAQ,UAAW,gBAC/B,EAAO,EAAK,QAAQ,WAAY,iBAChC,EAAO,EAAK,QAAQ,SAAU,YAC9B,EAAO,EAAK,QAAQ,QAAS,YAC7B,EAAO,EAAK,QAAQ,QAAS,QAC7B,EAAO,EAAK,QAAQ,UAAW,gBAC/B,EAAO,EAAK,QAAQ,WAAY,iBAChC,EAAO,EAAK,QAAQ,OAAQ,YAC5B,EAAO,EAAK,QAAQ,QAAS,QACtB,EAAK,OAAO,GAAG,cAAgB,EAAK,MAAM,GAG3C,aAAa,EAA2B,EAAyB,CACvE,EAAK,OAAO,QAAQ,GAAK,CAErB,EAAE,KAAO,EAAE,KAAK,QAAQ,iBAAkB,CAAC,EAAG,IAAS,CACnD,GAAI,GAAO,EAAO,MAAM,KAAK,gBAAgB,IAC7C,MAAO,SAAY,IAAQ,KAAO,EAAK,KAAO,kBAAoB,MAEtE,EAAE,KAAO,EAAE,KAAK,QAAQ,UAAW,QAC/B,EAAE,KAAK,MAAM,eACb,GAAE,OAAS,EAAE,OAAO,IAAI,CAAC,EAAG,IAAM,EAAI,GAAM,EAAI,CAAC,EAAI,IAErD,EAAE,KAAK,MAAM,aACb,GAAE,OAAS,EAAE,OAAO,IAAI,CAAC,EAAG,IAAO,GAAI,GAAM,EAAI,EAAI,CAAC,GAAK,QAGnE,EAAK,OAAS,EAAK,OAAO,OAAO,GAAK,CAAC,EAAE,KAAK,MAAM,qBC7C5D,OAAO,kBAAkB,MAAO,CAC5B,OAAQ,CACJ,IAAK,CAAE,QAAS,IAChB,YAAa,CAAE,QAAS,IACxB,MAAO,CAAE,QAAS,IAClB,cAAe,CAAE,QAAS,GAC1B,OAAQ,CAAE,KAAM,YAChB,cAAe,CAAE,QAAS,KAE9B,MAAO,CACH,KAAK,OAAS,MAElB,OAAO,EAAS,CACZ,AAAI,KAAK,KAAK,MAAQ,EAAQ,KAC1B,MAAK,SACL,KAAK,eAET,KAAK,iBAET,KAAK,EAAM,EAAW,CAClB,GAAI,CAAC,KAAK,OAAQ,CACd,KAAK,QACL,OAEJ,KAAK,OAAO,OAAO,EAAY,MAEnC,QAAS,CACL,AAAI,KAAK,QACL,MAAK,GAAG,eAAe,UACvB,KAAK,OAAO,iBAGd,cAAc,CAChB,GAAI,GAAK,KAAK,GACV,EAAM,KAAK,KAAK,IACpB,GAAI,EAAC,EAGL,GAAI,CACA,GAAI,GAAc,GAClB,AAAI,WAAW,QACX,EAAY,KAAK,CAAE,KAAM,UAAW,YAAa,CAAC,EAAG,IAAQ,GAAI,GAAmB,KAExF,GAAI,GAAS,KAAM,IAAI,KAAY,KAAK,EAAK,GAC7C,GAAI,GAAO,KAAK,KAAK,IAAK,CACtB,EAAO,UACP,OAEJ,KAAK,OAAS,EACd,EAAG,YAAY,SAAU,EAAO,OAChC,KAAK,gBACL,KAAK,OACL,EAAG,KAAK,eAAgB,CAAE,OAAQ,MAAO,MAAO,EAAO,MAAO,OAAQ,GAAU,UAC3E,EAAP,CACE,EAAG,KAAK,cAAe,CAAE,OAAQ,MAAO,IAAK,EAAK,MAAO,GAAK,MAGtE,eAAgB,CACZ,GAAI,CAAC,KAAK,OACN,OAEJ,GAAI,GAAO,KAAK,KAChB,KAAK,OAAO,eAAe,EAAK,aAChC,AAAI,EAAK,OACL,AAAI,EAAK,OAAO,SAAW,WACvB,KAAK,OAAO,aAAe,KAAK,GAAG,QAAQ,OAE3C,KAAK,OAAO,aAAe,EAAK,OAAO,SAG3C,KAAK,OAAO,aAAe,KAE/B,AAAI,EAAK,MACL,KAAK,OAAO,WAAW,EAAK,eAE5B,KAAK,OAAO,YAGhB,GAAI,GAAU,KAAK,OAAO,QAAQ,QAClC,GAAI,EAAS,CACT,GAAI,EAAK,eAAiB,EAAQ,OAAS,KAAM,CAC7C,GAAI,GAAS,KAAK,GAAG,QAAQ,QAAQ,QAErC,EAAQ,OAAO,GAAU,EAAO,QAAU,EAAO,OAAO,OAE5D,EAAQ,OAAS,EAAK,kBAKlC,OAAO,kBAAkB,WAAY,CACjC,OAAQ,CACJ,IAAK,CAAE,QAAS,IAChB,OAAQ,CAAE,QAAS,IACnB,KAAM,CAAE,QAAS,IACjB,SAAU,CAAE,QAAS,IACrB,YAAa,CAAE,QAAS,KAE5B,MAAO,CAEH,KAAK,OAAS,KACV,KAAK,GAAG,WAAW,KAAO,KAAK,GAAG,WAAW,IAAI,QACjD,MAAK,OAAS,KAAK,GAAG,WAAW,IAAI,QAEzC,KAAK,YAAc,AAAC,GAAO,CACvB,KAAK,OAAS,EAAG,OAAO,OACxB,AAAI,KAAK,KAAK,KAAO,GACjB,KAAK,UAAU,KAAK,KAAK,KACtB,AAAI,KAAK,OAAO,WAAW,OAAS,EACvC,KAAK,SAAS,KAAK,OAAO,WAAW,IAErC,KAAK,kBAGb,KAAK,GAAG,iBAAiB,eAAgB,KAAK,cAElD,OAAO,EAAS,CACZ,AAAI,EAAQ,KAAO,KAAK,KAAK,KAAO,KAAK,QACrC,KAAK,UAAU,KAAK,KAAK,WAQ3B,WAAU,EAAK,CAGjB,GAFA,KAAK,gBACL,KAAK,OAAO,WACR,IAAQ,GACR,OAEJ,GAAI,GAAO,KAAK,KAAK,KAAO,MAAM,WAAa,MAAM,SAGjD,EAAO,KAAM,AADJ,CADA,MAAK,KAAK,QAAW,GAAI,cAAc,SAAS,QAAU,MAAQ,MACxD,MAAQ,GAAI,GAAqB,GAAI,IACpC,KAAK,EAAK,KAAK,OAAQ,KAAK,MACpD,AAAI,CAAC,KAAK,QAGV,KAAK,SAAS,IAElB,eAAgB,CACZ,AAAI,KAAK,WACL,MAAK,UAAU,OACf,KAAK,OAAO,MAAM,YAAY,KAAK,MACnC,KAAK,OAAO,aAAa,SACzB,KAAK,UAAY,OAGzB,gBAAiB,CACb,GAAI,GAAI,CAAC,EAAG,EAAG,IAAM,GAAI,OAAM,aAAa,aAAa,GAAI,OAAM,MAAM,EAAI,KAAK,GAAK,IAAK,EAAI,KAAK,GAAK,IAAK,EAAI,KAAK,GAAK,MACzH,EAAS,CACT,aAAc,CACV,KAAM,CACF,CAAE,IAAK,EAAE,EAAG,EAAG,IAAK,KAAM,GAC1B,CAAE,IAAK,EAAE,EAAG,EAAG,IAAK,KAAM,GAC1B,CAAE,IAAK,EAAE,EAAG,EAAG,IAAK,KAAM,KAGlC,cAAe,CACX,KAAM,CACF,CAAE,IAAK,EAAE,EAAG,EAAG,KAAM,KAAM,GAC3B,CAAE,IAAK,EAAE,EAAG,EAAG,KAAM,KAAM,GAC3B,CAAE,IAAK,EAAE,EAAG,EAAG,KAAM,KAAM,KAGnC,MAAO,CACH,KAAM,CACF,CAAE,IAAK,EAAE,EAAG,EAAG,GAAI,KAAM,GACzB,CAAE,IAAK,EAAE,EAAG,EAAG,IAAK,KAAM,GAC1B,CAAE,IAAK,EAAE,EAAG,GAAI,GAAI,KAAM,GAC1B,CAAE,IAAK,EAAE,EAAG,EAAG,GAAI,KAAM,GACzB,CAAE,IAAK,EAAE,EAAG,EAAG,GAAI,KAAM,MAIjC,EAAO,MAAM,cAAc,eAC3B,CACI,KAAM,gBACN,UAAW,OAAO,OAAO,IAE7B,OAAO,KAAK,GAAQ,IAAI,GAAK,KAAK,OAAO,MAAM,IAAM,CAAE,KAAM,KAEjE,KAAK,SAAS,IAElB,SAAS,EAAM,CACX,GAAI,GAAO,KAAK,KAAK,KAAO,MAAM,WAAa,MAAM,SACrD,KAAK,gBACL,KAAK,KAAO,EACZ,KAAK,OAAO,MAAM,QAAQ,GAC1B,KAAK,UAAY,KAAK,OAAO,MAAM,WAAW,GAAM,QAAQ,GAAM,mBAAmB,GAAK,OAC1F,KAAK,UAAU,kBAAoB,IAEvC,QAAS,CACL,KAAK,GAAG,oBAAoB,eAAgB,KAAK,aACjD,KAAK,gBACL,KAAK,OAAS,QAItB,OAAO,kBAAkB,eAAgB,CACrC,OAAQ,CACJ,cAAe,CAAE,KAAM,OAAQ,QAAS,CAAE,EAAG,EAAG,EAAG,EAAG,EAAG,KAE7D,MAAO,CACH,KAAK,cAAgB,GACrB,KAAK,SAAW,KAAK,GAAG,QAAQ,SAC5B,KAAK,GAAG,WAAW,KAAO,KAAK,GAAG,WAAW,IAAI,QACjD,KAAK,iBAAiB,KAAK,GAAG,WAAW,IAAI,QAEjD,KAAK,YAAc,AAAC,GAAO,KAAK,iBAAiB,EAAG,OAAO,QAC3D,KAAK,GAAG,iBAAiB,eAAgB,KAAK,cAElD,iBAAiB,EAAQ,CACrB,AAAI,KAAK,QACL,KAAK,SAAS,OAAO,KAAK,QAE9B,KAAK,OAAS,GAAI,OAAM,eAAe,EAAO,OAC9C,KAAK,SAAS,IAAI,KAAK,QACvB,KAAK,mBAAmB,IAE5B,mBAAmB,EAAQ,CACvB,KAAK,oBAEL,GAAI,GAAU,EAAO,QAAQ,QAC7B,GAAI,CAAC,GAAW,CAAC,EAAQ,MACrB,OAEJ,GAAI,GAAW,GAAI,OAAM,eAAe,EAAG,EAAG,GAC1C,EAAW,GAAI,OAAM,kBAAkB,CAAE,MAAO,GAAI,OAAM,MAAM,OAAQ,UAAW,GAAM,UAAW,KACxG,EAAQ,OAAO,QAAQ,GAAQ,CAC3B,GAAI,GAAM,GAAI,OAAM,MACpB,EAAK,OAAO,QAAQ,CAAC,EAAO,IAAM,CAC9B,GAAI,GAAS,GAAI,OAAM,KAAK,EAAU,GACtC,EAAO,SAAS,KAAK,EAAK,aAAa,IACvC,EAAO,MAAM,eAAe,EAAM,sBAAwB,KAC1D,EAAI,IAAI,KAGZ,KAAK,SAAS,IAAI,GAClB,KAAK,cAAc,KAAK,CAAC,EAAM,OAGvC,mBAAoB,CAChB,KAAK,cAAc,QAAQ,CAAC,CAAC,EAAM,KAAS,EAAI,OAAO,OAAO,IAC9D,KAAK,cAAgB,IAEzB,MAAO,CACH,KAAK,cAAc,QAAQ,CAAC,CAAC,EAAM,KAAS,CACxC,EAAI,SAAS,KAAK,EAAK,UAAU,IAAI,KAAK,KAAK,eAC/C,EAAI,WAAW,KAAK,EAAK,eAGjC,QAAS,CACL,KAAK,GAAG,oBAAoB,eAAgB,KAAK,aACjD,KAAK,oBACD,KAAK,QACL,KAAK,SAAS,OAAO,KAAK,WAKtC,OAAO,kBAAkB,YAAa,CAClC,OAAQ,CACJ,MAAO,CAAE,QAAS,WAClB,kBAAmB,CAAE,QAAS,KAElC,MAAO,CACH,KAAK,MAAQ,GACb,KAAK,OAAS,GAAI,OAAM,QACxB,KAAK,OAAS,GAAI,OAAM,QACxB,KAAK,OAAS,GAAI,OAAM,WACxB,KAAK,OAAS,GAAI,OAAM,WACxB,KAAK,OAAS,GAAI,OAAM,QACpB,KAAK,GAAG,WAAW,KAAO,KAAK,GAAG,WAAW,IAAI,QACjD,KAAK,iBAAiB,KAAK,GAAG,WAAW,IAAI,QAEjD,KAAK,YAAc,AAAC,GAAO,KAAK,iBAAiB,EAAG,OAAO,QAC3D,KAAK,GAAG,iBAAiB,eAAgB,KAAK,cAElD,QAAS,CACL,KAAK,GAAG,oBAAoB,eAAgB,KAAK,aACjD,KAAK,kBAET,YAAY,EAAa,CACrB,GAAI,EAAC,KAAK,OAGV,MAAO,MAAK,OAAO,QAAQ,IAE/B,YAAY,EAAM,CACd,AAAI,CAAC,KAAK,QAGV,MAAK,OAAO,QAAQ,GACpB,KAAK,0BAET,iBAAiB,EAAQ,CACrB,KAAK,iBACL,KAAK,OAAS,EACd,GAAI,GAAW,GAAI,OAAM,YAAY,EAAG,EAAG,GACvC,EAAW,GAAI,OAAM,kBAAkB,CACvC,MAAO,GAAI,OAAM,MAAM,KAAK,KAAK,OACjC,YAAa,GAAM,QAAS,GAAK,UAAW,KAE5C,EAAM,KAAK,OAAQ,EAAM,KAAK,OAAQ,EAAK,KAAK,OAAQ,EAAK,KAAK,OAClE,EAAW,EAAO,MAAM,KACxB,EAAiB,GACrB,OAAS,KAAQ,QAAO,KAAK,EAAO,OAAQ,CACxC,GAAI,GAAO,EAAO,MAAM,GACpB,EAAS,GAAQ,EACjB,EAAO,GAAI,OAAM,KAAK,EAAU,GAChC,EAAW,SAAS,cAAc,YACtC,EAAS,UAAU,IAAI,cACvB,EAAS,aAAa,kBAAmB,IACzC,EAAS,YAAY,SAAU,GAC/B,GAAI,GAAe,EAAS,SACxB,EAAU,EAAK,SAAS,OAAO,CAAC,EAAG,IAAM,KAAK,IAAI,EAAG,EAAE,SAAS,UAAW,EAAK,SAAS,UAC7F,EAAa,MAAM,eAAe,KAAK,IAAI,KAAK,IAAI,EAAU,EAAG,KAAO,MACxE,EAAe,EAAK,MAAQ,EAC5B,EAAS,iBAAiB,YAAa,GAAM,CACzC,KAAK,GAAG,KAAK,mBAAoB,CAAE,KAAM,EAAM,KAAM,MAEzD,GAAI,GAAa,EAAK,OACtB,KAAO,CAAC,EAAe,EAAW,OAAS,EAAW,QAAU,EAAW,OAAO,QAC9E,EAAa,EAAW,OAE5B,EAAS,iBAAiB,UAAW,GAAM,CACvC,GAAI,EAAQ,CAER,GAAI,GAAI,EAAa,OAAO,aAAa,EAAK,iBAAiB,IAAM,IAAI,EAAa,UACtF,EAAO,MAAM,SAAS,IAAI,GAE9B,EAAW,kBAAkB,IAC7B,EAAa,kBAAkB,IAC/B,EAAG,WAAW,EAAW,aAAa,SAAS,EAAa,aAAa,UAAU,EAAK,EAAI,GAC5F,EAAK,WAAW,KAAK,KAAK,kBAAkB,EAAM,IAClD,EAAG,mBAAmB,EAAI,KAAK,EAAK,UAAU,YAAa,EAAI,aAC3D,EAAW,SAAS,QAAU,GAC9B,GAAW,WAAW,SAAS,GAC/B,KAAK,kBAAkB,EAAe,EAAW,MAAO,EAAW,aAEvE,KAAK,sBAAsB,EAAS,KAAO,KAE/C,EAAS,iBAAiB,aAAc,GAAM,CAC1C,KAAK,wBACL,QAAQ,IAAI,EAAW,KAAM,KAEjC,KAAK,GAAG,YAAY,GACpB,KAAK,MAAM,KAAK,CAAC,EAAM,IAE3B,KAAK,yBAET,kBAAkB,EAAM,EAAG,CACvB,GAAI,CAAC,KAAK,KAAK,kBACX,MAAO,GAEX,GAAI,GAAK,KAAK,OAAQ,EAAK,KAAK,OAC5B,EAAa,KAAK,OAAO,gBAAgB,GAC7C,GAAI,GAAc,EAAW,MAAQ,OAAQ,CACzC,GAAI,GAAQ,EAAI,KAAK,KAAK,EAAE,GAC5B,GAAI,EAAW,UAAW,CACtB,GAAI,GAAS,EAAQ,KAAK,KAAK,EAAE,GAAK,EAAG,KAAK,GAAG,YAAY,IAAI,EAAW,WAE5E,GADA,EAAS,KAAK,gBAAgB,GAC1B,KAAK,IAAI,GAAU,EAAW,WAAY,CAC1C,GAAI,GAAI,EAAS,EAAK,EAAS,EAAW,WAAe,EAAS,EAAW,WAC7E,EAAE,SAAS,EAAG,iBAAiB,EAAW,UAAW,CAAC,IACtD,EAAQ,EAAI,KAAK,KAAK,EAAE,IAGhC,AAAI,KAAK,IAAI,KAAK,gBAAgB,IAAU,EAAW,OACnD,EAAE,iBAAiB,EAAG,KAAK,GAAG,YAAa,EAAW,eAEnD,GAAc,EAAW,MAAQ,QAAS,CACjD,GAAI,GAAK,GAAW,IAAM,EAAW,KAAO,EACxC,EAAQ,EAAI,KAAK,KAAK,EAAE,GAAK,EAAG,KAAK,GAAG,YAAY,IAAI,EAAW,MACvE,EAAQ,MAAM,UAAU,MAAM,KAAK,gBAAgB,EAAQ,GAAI,EAAW,IAAM,EAAG,EAAW,IAAM,GACpG,EAAE,iBAAiB,EAAW,KAAM,EAAQ,GAEhD,MAAO,IAEX,gBAAgB,EAAO,CACnB,MAAO,GAAQ,KAAK,GAAK,EAAI,KAAK,MAAO,GAAQ,KAAK,IAAO,MAAK,GAAK,KAE3E,gBAAiB,CACb,KAAK,MAAM,QAAQ,CAAC,CAAC,EAAG,KAAO,CAC3B,KAAK,GAAG,YAAY,EAAE,IACtB,GAAI,GAAM,EAAE,GAAG,YAAY,UAC3B,AAAI,GACA,GAAI,SAAS,UACb,EAAI,SAAS,WAEjB,EAAE,GAAG,YAET,KAAK,MAAQ,IAEjB,sBAAsB,EAAU,CAC5B,GAAI,GAAK,KAAK,OACV,EAAY,KAAK,GAAG,SACxB,EAAU,kBAAkB,IAC5B,GAAI,GAAO,EAAU,YAAY,QAAQ,SACzC,KAAK,MAAM,QAAQ,CAAC,CAAC,EAAM,KAAY,CACnC,GAAI,GAAM,GAAQ,EAAW,EAAK,EAAO,SACzC,EAAK,kBAAkB,IACvB,EAAO,OAAO,KAAK,EAAK,aAAa,YAAY,GAAM,UAAU,EAAK,EAAO,WAAY,QAKrG,OAAO,kBAAkB,YAAa,CAClC,OAAQ,CACJ,eAAgB,CAAE,KAAM,WAAY,QAAS,IAC7C,uBAAwB,CAAE,KAAM,QAChC,uBAAwB,CAAE,KAAM,OAAQ,QAAS,CAAE,EAAG,EAAG,EAAG,CAAC,KAAK,GAAK,EAAG,EAAG,IAC7E,gBAAiB,CAAE,KAAM,WAAY,QAAS,IAC9C,wBAAyB,CAAE,KAAM,QACjC,wBAAyB,CAAE,KAAM,OAAQ,QAAS,CAAE,EAAG,EAAG,EAAG,KAAK,GAAK,EAAG,EAAG,IAC7E,cAAe,CAAE,KAAM,WAAY,QAAS,IAC5C,eAAgB,CAAE,KAAM,WAAY,QAAS,IAC7C,WAAY,CAAE,KAAM,WAAY,QAAS,IACzC,aAAc,CAAE,KAAM,OAAQ,QAAS,CAAE,EAAG,EAAG,EAAG,EAAG,EAAG,KAE5D,MAAO,CACH,KAAK,OAAS,GAAI,OAAM,QACxB,KAAK,OAAS,GAAI,OAAM,QACxB,KAAK,OAAS,GAAI,OAAM,WACxB,KAAK,OAAS,GAAI,OAAM,WACxB,KAAK,OAAS,GAAI,OAAM,QACxB,KAAK,UAAY,GACb,KAAK,GAAG,WAAW,KAAO,KAAK,GAAG,WAAW,IAAI,QACjD,KAAK,iBAAiB,KAAK,GAAG,WAAW,IAAI,QAEjD,KAAK,YAAc,AAAC,GAAO,KAAK,iBAAiB,EAAG,OAAO,QAC3D,KAAK,GAAG,iBAAiB,eAAgB,KAAK,cAElD,QAAS,CACL,AAAI,KAAK,KAAK,WACV,AAAI,KAAK,KAAK,WAAW,SAAW,WAChC,KAAK,WAAa,KAAK,GAAG,QAAQ,OAElC,KAAK,WAAa,KAAK,KAAK,WAAW,SAG3C,KAAK,WAAa,KAGtB,KAAK,gBAAkB,GAAI,OAAM,UAAU,QACvC,KAAK,KAAK,wBACV,GAAI,OAAM,aAAa,aAAa,GAAI,OAAM,QAAQ,eAAe,KAAK,KAAK,0BAC/E,GAAI,OAAM,QAAQ,EAAG,EAAG,IAC5B,KAAK,eAAiB,GAAI,OAAM,UAAU,QACtC,KAAK,KAAK,uBACV,GAAI,OAAM,aAAa,aAAa,GAAI,OAAM,QAAQ,eAAe,KAAK,KAAK,yBAC/E,GAAI,OAAM,QAAQ,EAAG,EAAG,KAEhC,iBAAiB,EAAQ,CACrB,KAAK,OAAS,EACd,OAAS,KAAM,MAAK,UAChB,KAAK,GAAG,YAAY,GAExB,KAAK,UAAY,GACjB,KAAK,SACL,KAAK,uBAAuB,IAEhC,uBAAuB,EAAQ,CAC3B,GAAI,GAAS,GAAI,GACjB,KAAK,OAAS,GACd,GAAI,GAAe,CAAC,EAAW,EAAU,IAAW,CAChD,AAAI,GAAY,MACZ,GAAW,SAAS,cAAc,SAClC,EAAS,UAAU,IAAI,cACvB,EAAS,aAAa,kBAAmB,IACzC,EAAS,aAAa,WAAY,CAAE,MAAO,IAAM,MAAO,IAAM,OAAQ,MACtE,EAAS,aAAa,WAAY,CAAE,MAAO,OAAQ,UAAW,GAAO,YAAa,GAAM,QAAS,KACjG,KAAK,GAAG,YAAY,GACpB,KAAK,UAAU,KAAK,IAExB,GAAI,GAAM,CAAC,EAAG,IAAM,EAAE,aAAa,EAAE,iBAAiB,GAAI,OAAM,UAChE,EAAY,EAAU,OAAO,GAAQ,EAAO,MAAM,IAClD,GAAI,GAAW,EAAU,IAAI,GAAQ,EAAO,MAAM,IAC9C,EAAQ,EAAS,IAAI,CAAC,EAAG,IAAM,CAC/B,GAAI,GAAW,GAAK,EAAI,EAAE,SAAW,EAAI,EAAG,EAAS,EAAI,IACrD,EAAiB,EAAO,gBAAgB,EAAU,IAClD,EAAa,EAAiB,CAC9B,MAAO,GACI,KAAK,kBAAkB,EAAgB,EAAO,aAEzD,KACJ,MAAO,IAAI,GAAO,EAAU,EAAY,KAE5C,YAAK,OAAO,KAAK,CAAC,EAAS,EAAS,OAAS,GAAI,EAAS,SAAU,IAC7D,CAAE,KAAM,EAAS,GAAI,QAAS,EAAO,MAAO,EAAU,OAAQ,EAAS,WAGlF,KAAK,OAAS,CACV,EAAa,CAAC,eAAgB,eAAgB,YAAa,KAAK,KAAK,eAAgB,KAAK,gBAC1F,EAAa,CAAC,gBAAiB,gBAAiB,aAAc,KAAK,KAAK,gBAAiB,KAAK,iBAC9F,EAAa,CAAC,eAAgB,eAAgB,YAAa,KAAK,KAAK,eACrE,EAAa,CAAC,gBAAiB,gBAAiB,aAAc,KAAK,KAAK,iBAG5E,KAAK,SAAW,GAEpB,kBAAkB,EAAY,EAAG,CAC7B,GAAI,GAAK,KAAK,OAAQ,EAAK,KAAK,OAAQ,EAAQ,GAChD,GAAI,GAAc,EAAW,MAAQ,OAAQ,CACzC,GAAI,GAAQ,EAAI,KAAK,KAAK,EAAE,GAC5B,GAAI,EAAW,UAAW,CACtB,GAAI,GAAS,EAAQ,KAAK,KAAK,EAAE,GAAK,EAAG,KAAK,GAAG,YAAY,IAAI,EAAW,WAE5E,GADA,EAAS,KAAK,gBAAgB,GAC1B,KAAK,IAAI,GAAU,EAAW,WAAY,CAC1C,GAAI,GAAI,EAAS,EAAK,EAAS,EAAW,WAAe,EAAS,EAAW,WAC7E,EAAE,SAAS,EAAG,iBAAiB,EAAW,UAAW,CAAC,IACtD,EAAQ,EAAI,KAAK,KAAK,EAAE,GACxB,EAAQ,IAGhB,AAAI,KAAK,IAAI,KAAK,gBAAgB,IAAU,EAAW,OACnD,GAAE,iBAAiB,EAAG,KAAK,GAAG,YAAa,EAAW,OACtD,EAAQ,YAEL,GAAc,EAAW,MAAQ,QAAS,CACjD,GAAI,GAAK,GAAW,IAAM,EAAW,KAAO,EACxC,EAAM,EAAG,KAAK,GAAG,YAAY,IAAI,EAAW,MAC5C,EAAQ,EAAI,KAAK,KAAK,EAAE,GAAK,EACjC,EAAQ,MAAM,UAAU,MAAM,KAAK,gBAAgB,EAAQ,GAAI,EAAW,IAAM,EAAG,EAAW,IAAM,GACpG,EAAE,iBAAiB,EAAW,KAAM,EAAQ,GAC5C,EAAQ,GAEZ,MAAO,IAEX,gBAAgB,EAAO,CACnB,MAAO,GAAQ,KAAK,GAAK,EAAI,KAAK,MAAO,GAAQ,KAAK,IAAO,MAAK,GAAK,KAE3E,KAAK,EAAM,EAAW,CAClB,GAAI,EAAC,KAAK,OAGV,IAAI,KAAK,WAAY,CACjB,GAAI,GAAW,KAAK,OAChB,EAAU,KAAK,OACnB,KAAK,WAAW,YAAY,UAAU,EAAU,EAAS,KAAK,QAC9D,EAAS,EAAI,EACb,KAAK,OAAO,MAAM,SAAS,KAAK,EAAS,IAAI,KAAK,KAAK,eACvD,GAAI,GAAO,KAAK,OAAO,gBACvB,GAAI,EAAM,CACN,GAAI,GAAI,KAAK,OAAO,sBAAsB,EAAK,OAAO,aAAa,SACnE,EAAK,WAAW,KAAK,EAAQ,YAAY,KAGjD,GAAI,KAAK,SAAU,CACf,GAAI,GAAK,KAAK,GAAG,SAAS,YAAY,QAAQ,SAC9C,OAAS,KAAS,MAAK,OAAQ,CAE3B,GAAI,GAAU,EAAM,KAAK,OAAO,YAAY,QAAQ,YAAY,GAC5D,KAAK,SAAS,MAAM,EAAM,QAAS,EAAM,OAAO,SAAU,GAC1D,EAAM,QAAQ,QAAQ,CAAC,EAAQ,IAAM,CACjC,GAAI,GAAK,EAAM,QAAQ,OAAS,EAAG,OACnC,GAAI,GAAI,EAAO,SAAS,WAAW,QAAQ,EAAO,YAClD,AAAI,EAAI,GACJ,EAAO,SAAS,WAAW,MAAM,EAAO,WAAY,GAAM,GAE1D,EAAO,SAAS,WAAW,KAAK,EAAO,cAMvD,KAAK,OAAO,QAAQ,CAAC,CAAC,EAAM,EAAG,KAAY,CACvC,GAAI,GAAI,EAAS,EAAE,YAAY,QAAQ,SAAS,GAAU,EAAE,YACxD,EAAI,KAAK,OAAO,sBAAsB,EAAK,OAAO,aAAa,SACnE,EAAK,WAAW,KAAK,KAAK,OAAO,sBAAsB,GAAG,YAAY,SAIlF,QAAS,CACL,KAAK,GAAG,oBAAoB,eAAgB,KAAK,aACjD,OAAS,KAAM,MAAK,UAChB,KAAK,GAAG,YAAY",
  "names": []
}
